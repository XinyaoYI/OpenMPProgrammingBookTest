
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>9. Data Environment &#8212; OpenMP Application Programming Interface Examples</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="10. Memory Model" href="../Chap_memory_model/Chap_memory_model.html" />
    <link rel="prev" title="8. Synchronization" href="../Chap_synchronization/Chap_synchronization.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">OpenMP Application Programming Interface Examples</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Welcome to OMP Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Title_Page.html">
   Cover
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Foreword_Chapt.html">
   Foreword
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chap_introduction/Chap_introduction.html">
   1. Introduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chap_introduction/Section_Examples_Organization.html">
     1.1. Examples Organization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_directives/Chap_directives.html">
   2. OpenMP Directive Syntax
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_parallel_execution/Chap_parallel_execution.html">
   3. Parallel Execution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_tasking/Chap_tasking.html">
   4. Tasking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_devices/Chap_devices.html">
   5. Devices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_SIMD/Chap_SIMD.html">
   6. SIMD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_loop_transformations/Chap_loop_transformations.html">
   7. Loop Transformations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_synchronization/Chap_synchronization.html">
   8. Synchronization
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   9. Data Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_memory_model/Chap_memory_model.html">
   10. Memory Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_program_control/Chap_program_control.html">
   11. Program Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chap_ompt_interface/Chap_ompt_interface.html">
   12. OMPT Interface
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/passlab/Examples/main?urlpath=lab/tree/notebook/contents/Chap_data_environment/Chap_data_environment.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/passlab/Examples"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/passlab/Examples/issues/new?title=Issue%20on%20page%20%2Fcontents/Chap_data_environment/Chap_data_environment.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/contents/Chap_data_environment/Chap_data_environment.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#threadprivate-directive">
   9.1.
   <strong>
    threadprivate
   </strong>
   Directive
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#default-none-clause">
   9.2.
   <strong>
    default(none)
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#private-clause">
   9.3.
   <strong>
    private
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-private-loop-iteration-variables">
   9.4. Fortran Private Loop Iteration Variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-restrictions-on-shared-and-private-clauses-with-common-blocks">
   9.5. Fortran Restrictions on
   <strong>
    shared
   </strong>
   and
   <strong>
    private
   </strong>
   Clauses with Common Blocks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-restrictions-on-storage-association-with-the-private-clause">
   9.6. Fortran Restrictions on Storage Association with the
   <strong>
    private
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-c-arrays-in-a-firstprivate-clause">
   9.7. C/C++ Arrays in a
   <strong>
    firstprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lastprivate-clause">
   9.8.
   <strong>
    lastprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduction">
   9.9. Reduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-clause">
     9.9.1.
     <strong>
      reduction
     </strong>
     Clause
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#task-reduction">
     9.9.2. Task Reduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-on-combined-target-constructs">
     9.9.3. Reduction on Combined Target Constructs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#task-reduction-with-target-constructs">
     9.9.4. Task Reduction with Target Constructs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#taskloop-reduction">
     9.9.5. Taskloop Reduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-with-the-scope-construct">
     9.9.6. Reduction with the
     <strong>
      scope
     </strong>
     Construct
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#user-defined-reduction">
     9.9.7. User-Defined Reduction
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scan-directive">
   9.10.
   <strong>
    scan
   </strong>
   Directive
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyin-clause">
   9.11.
   <strong>
    copyin
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyprivate-clause">
   9.12.
   <strong>
    copyprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-reference-in-data-sharing-clauses">
   9.13. C++ Reference in Data-Sharing Clauses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-associate-construct">
   9.14. Fortran
   <strong>
    ASSOCIATE
   </strong>
   Construct
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Data Environment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#threadprivate-directive">
   9.1.
   <strong>
    threadprivate
   </strong>
   Directive
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#default-none-clause">
   9.2.
   <strong>
    default(none)
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#private-clause">
   9.3.
   <strong>
    private
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-private-loop-iteration-variables">
   9.4. Fortran Private Loop Iteration Variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-restrictions-on-shared-and-private-clauses-with-common-blocks">
   9.5. Fortran Restrictions on
   <strong>
    shared
   </strong>
   and
   <strong>
    private
   </strong>
   Clauses with Common Blocks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-restrictions-on-storage-association-with-the-private-clause">
   9.6. Fortran Restrictions on Storage Association with the
   <strong>
    private
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-c-arrays-in-a-firstprivate-clause">
   9.7. C/C++ Arrays in a
   <strong>
    firstprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lastprivate-clause">
   9.8.
   <strong>
    lastprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduction">
   9.9. Reduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-clause">
     9.9.1.
     <strong>
      reduction
     </strong>
     Clause
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#task-reduction">
     9.9.2. Task Reduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-on-combined-target-constructs">
     9.9.3. Reduction on Combined Target Constructs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#task-reduction-with-target-constructs">
     9.9.4. Task Reduction with Target Constructs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#taskloop-reduction">
     9.9.5. Taskloop Reduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-with-the-scope-construct">
     9.9.6. Reduction with the
     <strong>
      scope
     </strong>
     Construct
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#user-defined-reduction">
     9.9.7. User-Defined Reduction
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scan-directive">
   9.10.
   <strong>
    scan
   </strong>
   Directive
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyin-clause">
   9.11.
   <strong>
    copyin
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyprivate-clause">
   9.12.
   <strong>
    copyprivate
   </strong>
   Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-reference-in-data-sharing-clauses">
   9.13. C++ Reference in Data-Sharing Clauses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fortran-associate-construct">
   9.14. Fortran
   <strong>
    ASSOCIATE
   </strong>
   Construct
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="data-environment">
<h1><span class="section-number">9. </span>Data Environment<a class="headerlink" href="#data-environment" title="Permalink to this headline">#</a></h1>
<p>The OpenMP  <em>data environment</em>  contains data attributes of variables and objects.  Many constructs (such as <strong>parallel</strong>, <strong>simd</strong>, <strong>task</strong>)  accept clauses to control  <em>data-sharing</em>  attributes of referenced variables in the construct, where  <em>data-sharing</em>  applies to whether the attribute of the variable is  <em>shared</em> ,  is  <em>private</em>  storage, or has special operational characteristics  (as found in the <strong>firstprivate</strong>, <strong>lastprivate</strong>, <strong>linear</strong>, or <strong>reduction</strong> clause).</p>
<p>The data environment for a device (distinguished as a  <em>device data environment</em> ) is controlled on the host by  <em>data-mapping</em>  attributes, which determine the relationship of the data on the host, the  <em>original</em>  data, and the data on the device, the  <em>corresponding</em>  data.</p>
<p>DATA-SHARING ATTRIBUTES</p>
<p>Data-sharing attributes of variables can be classified as being  <em>predetermined</em> ,  <em>explicitly determined</em>  or  <em>implicitly determined</em> .</p>
<p>Certain variables and objects have predetermined attributes.   A commonly found case is the loop iteration variable in associated loops  of a <strong>for</strong> or <strong>do</strong> construct. It has a private data-sharing attribute. Variables with predetermined data-sharing attributes cannot be listed in a data-sharing clause; but there are some exceptions (mainly concerning loop iteration variables).</p>
<p>Variables with explicitly determined data-sharing attributes are those that are referenced in a given construct and are listed in a data-sharing attribute clause on the construct. Some of the common data-sharing clauses are: <strong>shared</strong>, <strong>private</strong>, <strong>firstprivate</strong>, <strong>lastprivate</strong>,  <strong>linear</strong>, and <strong>reduction</strong>.</p>
<p>Variables with implicitly determined data-sharing attributes are those that are referenced in a given construct, do not have predetermined data-sharing attributes, and are not listed in a data-sharing attribute clause of an enclosing construct. For a complete list of variables and objects with predetermined and implicitly determined attributes, please refer to the  <em>Data-sharing Attribute Rules for Variables Referenced in a Construct</em>  subsection of the OpenMP Specifications document.</p>
<p>DATA-MAPPING ATTRIBUTES</p>
<p>The <strong>map</strong> clause on a device construct explicitly specifies how the list items in the clause are mapped from the encountering task’s data environment (on the host) to the corresponding item in the device data environment (on the device). The common  <em>list items</em>  are arrays, array sections, scalars, pointers, and structure elements (members).</p>
<p>Procedures and global variables have predetermined data mapping if they appear within the list or block of a <strong>declare</strong> <strong>target</strong> directive. Also, a C/C++ pointer is mapped as a zero-length array section, as is a C++ variable that is a reference to a pointer.</p>
<p>Without explicit mapping, non-scalar and non-pointer variables within the scope of the <strong>target</strong> construct are implicitly mapped with a  <em>map-type</em>  of <strong>tofrom</strong>. Without explicit mapping, scalar variables within the scope of the <strong>target</strong> construct are not mapped, but have an implicit firstprivate data-sharing attribute. (That is, the value of the original variable is given to a private variable of the same name on the device.) This behavior can be changed with the <strong>defaultmap</strong> clause.</p>
<p>The <strong>map</strong> clause can appear on <strong>target</strong>, <strong>target data</strong> and  <strong>target enter/exit data</strong> constructs.  The operations of creation and removal of device storage as well as assignment of the original list item  values to the corresponding list items may be complicated when the list  item appears on multiple constructs or when the host and device storage  is shared. In these cases the item’s reference count, the number of times it has been referenced (+1 on entry and -1 on exited) in nested (structured) map regions and/or accumulative (unstructured) mappings, determines the operation. Details of the <strong>map</strong> clause and reference count operation are specified  in the  <em>map Clause</em>  subsection of the OpenMP Specifications document.</p>
<section id="threadprivate-directive">
<h2><span class="section-number">9.1. </span><strong>threadprivate</strong> Directive<a class="headerlink" href="#threadprivate-directive" title="Permalink to this headline">#</a></h2>
<p>The following examples demonstrate how to use the <strong>threadprivate</strong> directive   to give each thread a separate counter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: threadprivate.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(counter)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">increment_counter</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">threadprivate</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">INCREMENT_COUNTER</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="o">/</span><span class="n">INC_COMMON</span><span class="o">/</span><span class="n">COUNTER</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">INC_COMMON</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNTER</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">INCREMENT_COUNTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNTER</span><span class="w"></span>
<span class="w">        </span><span class="n">RETURN</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">INCREMENT_COUNTER</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example uses <strong>threadprivate</strong> on a static variable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: threadprivate.2</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">increment_counter_2</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp threadprivate(counter)</span>
<span class="w">  </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example demonstrates unspecified behavior for the initialization  of a <strong>threadprivate</strong> variable. A <strong>threadprivate</strong>  variable is initialized  once at an unspecified point before its first reference. Because <strong>a</strong> is  constructed using the value of <strong>x</strong>  (which is modified by the statement  <strong>x++</strong>), the value of <strong>a.val</strong>  at the start of the <strong>parallel</strong>  region could be either 1 or 2. This problem is avoided for <strong>b</strong>, which uses  an auxiliary <strong>const</strong> variable and a copy-constructor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: threadprivate.3</span>
<span class="cm">* type: C++</span>
<span class="cm">*/</span><span class="w"></span>
<span class="n">class</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="p">);</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">T</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">){</span><span class="w"></span>
<span class="w">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">T</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">b</span><span class="p">){</span><span class="w"></span>
<span class="w">   </span><span class="n">a</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">T</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">b_aux</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Capture value of x = 1 */</span><span class="w"></span>
<span class="n">T</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">b_aux</span><span class="p">);</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(a, b)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp parallel for</span>
<span class="w">   </span><span class="cm">/* In each thread:</span>
<span class="cm">    * a is constructed from x (with value 1 or 2?)</span>
<span class="cm">    * b is copy-constructed from b_aux</span>
<span class="cm">    */</span><span class="w"></span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Value of a is unspecified. */</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following examples show non-conforming uses and correct uses of the <strong>threadprivate</strong>  directive.</p>
<p>The following example is non-conforming because the common block is not declared  local to the subroutine that refers to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">threadprivate</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">MODULE</span><span class="w"> </span><span class="n">INC_MODULE</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">INC_MODULE</span><span class="w"></span>

<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_MODULE_WRONG</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">USE</span><span class="w"> </span><span class="n">INC_MODULE</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">non</span><span class="o">-</span><span class="n">conforming</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">INC_MODULE_WRONG</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_MODULE_WRONG</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is also non-conforming because the common block is not declared  local to the subroutine that refers to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">threadprivate</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_WRONG</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">CONTAINS</span><span class="w"></span>
<span class="w">          </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_WRONG_SUB</span><span class="p">()</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">COPYIN</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">non</span><span class="o">-</span><span class="n">conforming</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">INC_WRONG_SUB</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_WRONG_SUB</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_WRONG</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is a correct rewrite of the previous example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">threadprivate</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">       </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_GOOD</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">CONTAINS</span><span class="w"></span>
<span class="w">          </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_GOOD_SUB</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">COPYIN</span><span class="p">(</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">         </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_GOOD_SUB</span><span class="w"></span>
<span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INC_GOOD</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following is an example of the use of <strong>threadprivate</strong> for local variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name: threadprivate.5
! type: F-fixed
      PROGRAM INC_GOOD2
        INTEGER, ALLOCATABLE, SAVE :: A(:)
        INTEGER, POINTER, SAVE :: PTR
        INTEGER, SAVE :: I
        INTEGER, TARGET :: TARG
        LOGICAL :: FIRSTIN = .TRUE.
!$OMP   THREADPRIVATE(A, I, PTR)

        ALLOCATE (A(3))
        A = (/1,2,3/)
        PTR =&gt; TARG
        I = 5

!$OMP   PARALLEL COPYIN(I, PTR)
!$OMP     CRITICAL
            IF (FIRSTIN) THEN
              TARG = 4           ! Update target of ptr
              I = I + 10
              IF (ALLOCATED(A)) A = A + 10
              FIRSTIN = .FALSE.
            END IF

            IF (ALLOCATED(A)) THEN
              PRINT *, &#39;a = &#39;, A
            ELSE
              PRINT *, &#39;A is not allocated&#39;
            END IF

            PRINT *, &#39;ptr = &#39;, PTR
            PRINT *, &#39;i = &#39;, I
            PRINT *

!$OMP     END CRITICAL
!$OMP   END PARALLEL
      END PROGRAM INC_GOOD2
</pre></div>
</div>
</div>
</div>
<p>The above program, if executed by two threads, will print one of the following  two sets of output:</p>
<p><strong>a = 11 12 13</strong><br />
<strong>ptr = 4</strong>  <strong>i = 15</strong></p>
<p><strong>A is not allocated</strong><br />
<strong>ptr = 4</strong><br />
<strong>i = 5</strong></p>
<p>or</p>
<p><strong>A is not allocated</strong><br />
<strong>ptr = 4</strong><br />
<strong>i = 15</strong></p>
<p><strong>a = 1 2 3</strong><br />
<strong>ptr = 4</strong><br />
<strong>i = 5</strong></p>
<p>The following is an example of the use of <strong>threadprivate</strong> for module variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">threadprivate</span><span class="mf">.6</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">MODULE</span><span class="w"> </span><span class="n">INC_MODULE_GOOD3</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="p">,</span><span class="w"> </span><span class="n">POINTER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">WORK</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">SAVE</span><span class="w"> </span><span class="n">WORK</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="n">WORK</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">INC_MODULE_GOOD3</span><span class="w"></span>

<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB1</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">USE</span><span class="w"> </span><span class="n">INC_MODULE_GOOD3</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">THE_SUM</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">ALLOCATE</span><span class="p">(</span><span class="n">WORK</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB2</span><span class="p">(</span><span class="n">THE_SUM</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="n">THE_SUM</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB1</span><span class="w"></span>

<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB2</span><span class="p">(</span><span class="n">THE_SUM</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">USE</span><span class="w"> </span><span class="n">INC_MODULE_GOOD3</span><span class="w"></span>
<span class="w">        </span><span class="n">WORK</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">        </span><span class="n">THE_SUM</span><span class="o">=</span><span class="n">SUM</span><span class="p">(</span><span class="n">WORK</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB2</span><span class="w"></span>

<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">INC_GOOD3</span><span class="w"></span>
<span class="w">        </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">        </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB1</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">INC_GOOD3</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example illustrates initialization of <strong>threadprivate</strong> variables  for class-type <strong>T</strong>. <strong>t1</strong> is default constructed, <strong>t2</strong> is constructed  taking a constructor accepting one argument of integer type, <strong>t3</strong> is copy  constructed with argument <strong>f()</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: threadprivate.4</span>
<span class="cm">* type: C++</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"> </span><span class="o">~</span><span class="n">T</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">();</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(t1)</span>
<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">t2</span><span class="p">(</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(t2)</span>
<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">t3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(t3)</span>
</pre></div>
</div>
</div>
</div>
<p>The following example illustrates the use of <strong>threadprivate</strong> for static  class members. The <strong>threadprivate</strong> directive for a static class member must  be placed inside the class definition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: threadprivate.5</span>
<span class="cm">* type: C++</span>
<span class="cm">*/</span><span class="w"></span>
<span class="n">class</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="n">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(i)</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="default-none-clause">
<h2><span class="section-number">9.2. </span><strong>default(none)</strong> Clause<a class="headerlink" href="#default-none-clause" title="Permalink to this headline">#</a></h2>
<p>The following example distinguishes the variables that are affected by the <strong>default(none)</strong>  clause from those that are not.</p>
<p>Beginning with OpenMP 4.0, variables with <strong>const</strong>-qualified type and no mutable member  are no longer predetermined shared.  Thus, these variables (variable  <em>c</em>  in the example)  need to be explicitly listed in data-sharing attribute clauses when the <strong>default(none)</strong> clause is specified.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: default_none.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(x)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">default_none</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel default(none) private(a) shared(z, c)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_num_threads</span><span class="p">();</span><span class="w"></span>
<span class="w">          </span><span class="cm">/* O.K.  - j is declared within parallel region */</span><span class="w"></span>
<span class="w">     </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">];</span><span class="w">   </span><span class="cm">/* O.K.  - a is listed in private clause */</span><span class="w"></span>
<span class="w">                 </span><span class="cm">/*       - z is listed in shared clause */</span><span class="w"></span>
<span class="w">     </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">      </span><span class="cm">/* O.K.  - x is threadprivate */</span><span class="w"></span>
<span class="w">                 </span><span class="cm">/*       - c has const-qualified type and</span>
<span class="cm">                              is listed in shared clause */</span><span class="w"></span>
<span class="w">     </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Error - cannot reference i or y here */</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp for firstprivate(y)</span>
<span class="w">         </span><span class="cm">/* Error - Cannot reference y in the firstprivate clause */</span><span class="w"></span>
<span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="cm">/* O.K. - i is the loop iteration variable */</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Error - cannot reference i or y here */</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">default_none</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">DEFAULT_NONE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">INCLUDE</span><span class="w"> </span><span class="s">&quot;omp_lib.h&quot;</span><span class="w">     </span><span class="o">!</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">OMP_LIB</span><span class="w"></span>

<span class="w">      </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">A</span><span class="w"></span>

<span class="w">      </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">Z</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">COMMON</span><span class="o">/</span><span class="n">BLOCKX</span><span class="o">/</span><span class="n">X</span><span class="w"></span>
<span class="w">      </span><span class="n">COMMON</span><span class="o">/</span><span class="n">BLOCKY</span><span class="o">/</span><span class="n">Y</span><span class="w"></span>
<span class="w">      </span><span class="n">COMMON</span><span class="o">/</span><span class="n">BLOCKZ</span><span class="o">/</span><span class="n">Z</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">BLOCKX</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="w"></span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="p">(</span><span class="n">NONE</span><span class="p">)</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OMP_GET_NUM_THREADS</span><span class="p">();</span><span class="w"></span>
<span class="w">                   </span><span class="o">!</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">K</span><span class="p">.</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">listed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="n">clause</span><span class="w"></span>
<span class="w">          </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">K</span><span class="p">.</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">listed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="n">clause</span><span class="w"></span>
<span class="w">                   </span><span class="o">!</span><span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">listed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">SHARED</span><span class="w"> </span><span class="n">clause</span><span class="w"></span>
<span class="w">          </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">K</span><span class="p">.</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">THREADPRIVATE</span><span class="w"></span>
<span class="w">          </span><span class="n">Z</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="n">here</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">firstprivate</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">firstprivate</span><span class="w"> </span><span class="n">clause</span><span class="w"></span>
<span class="w">          </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="w"></span>
<span class="w">             </span><span class="n">Z</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">K</span><span class="p">.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="n">variable</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>


<span class="w">          </span><span class="n">Z</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">DEFAULT_NONE</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="private-clause">
<h2><span class="section-number">9.3. </span><strong>private</strong> Clause<a class="headerlink" href="#private-clause" title="Permalink to this headline">#</a></h2>
<p>In the following example, the values of original list items  <em>i</em>  and  <em>j</em>   are retained on exit from the <strong>parallel</strong> region, while the private list  items  <em>i</em>  and  <em>j</em>  are modified within the <strong>parallel</strong> construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: private.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_i</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_j</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ptr_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">ptr_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">j</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel private(i) firstprivate(j)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ptr_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">private</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_EXAMPLE</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="w"></span>

<span class="w">        </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="n">FIRSTPRIVATE</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">          </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="w">        </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="w">  </span><span class="o">!</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="n">and</span><span class="p">.</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_EXAMPLE</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In the following example, all uses of the variable  <em>a</em>  within the loop construct  in the routine  <em>f</em>  refer to a private list item  <em>a</em> , while it is  unspecified whether references to  <em>a</em>  in the routine  <em>g</em>  are to a  private list item or the original list item.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: private.2</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Accessed in the region but outside of the construct;</span>
<span class="cm">          * therefore unspecified whether original or private list</span>
<span class="cm">          * item is modified. */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel for private(a)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span><span class="w">     </span><span class="cm">/* Private copy of &quot;a&quot; */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">private</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">MODULE</span><span class="w"> </span><span class="n">PRIV_EXAMPLE2</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="n">A</span><span class="w"></span>

<span class="w">        </span><span class="n">CONTAINS</span><span class="w"></span>

<span class="w">          </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">REAL</span><span class="w"> </span><span class="n">K</span><span class="w"></span>
<span class="w">            </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="w">  </span><span class="o">!</span><span class="w"> </span><span class="n">Accessed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">outside</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"></span>
<span class="w">                   </span><span class="o">!</span><span class="w"> </span><span class="n">construct</span><span class="p">;</span><span class="w"> </span><span class="n">therefore</span><span class="w"> </span><span class="n">unspecified</span><span class="w"> </span><span class="n">whether</span><span class="w"></span>
<span class="w">                   </span><span class="o">!</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">modified</span><span class="p">.</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">G</span><span class="w"></span>

<span class="w">          </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">F</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="w">          </span><span class="n">REAL</span><span class="w"> </span><span class="n">A</span><span class="w"></span>

<span class="w">            </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">                </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">                </span><span class="n">CALL</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="n">ENDDO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">F</span><span class="w"></span>

<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">PRIV_EXAMPLE2</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example demonstrates that a list item that appears in a <strong>private</strong>   clause in a <strong>parallel</strong> construct may also appear in a <strong>private</strong>   clause in an enclosed worksharing construct, which results in an additional private  copy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: private.3</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">priv_example3</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel private(a)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp parallel for private(a)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">private</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">PRIV_EXAMPLE3</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">            </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="w">        </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">Outer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">PRIV_EXAMPLE3</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fortran-private-loop-iteration-variables">
<h2><span class="section-number">9.4. </span>Fortran Private Loop Iteration Variables<a class="headerlink" href="#fortran-private-loop-iteration-variables" title="Permalink to this headline">#</a></h2>
<p>In general loop iteration variables will be private, when used in the  <em>do-loop</em>   of a <strong>do</strong> and <strong>parallel do</strong> construct or in sequential loops in a  <strong>parallel</strong> construct (see Section 2.7.1 and Section 2.14.1 of  the OpenMP 4.0 specification). In the following example of a sequential  loop in a <strong>parallel</strong> construct the loop iteration variable  <em>I</em>  will  be private.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_loopvar</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">PLOOP_1</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="n">INCLUDE</span><span class="w"> </span><span class="s">&quot;omp_lib.h&quot;</span><span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">OMP_LIB</span><span class="w"></span>

<span class="n">REAL</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">MYOFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">MYOFFSET</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">MYOFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OMP_GET_THREAD_NUM</span><span class="p">()</span><span class="o">*</span><span class="n">N</span><span class="w"></span>
<span class="w">       </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="w">         </span><span class="n">A</span><span class="p">(</span><span class="n">MYOFFSET</span><span class="o">+</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLOAT</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">ENDDO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">PLOOP_1</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In exceptional cases, loop iteration variables can be made shared, as in the following  example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name: fort_loopvar.2
! type: F-free
SUBROUTINE PLOOP_2(A,B,N,I1,I2)
REAL A(*), B(*)
INTEGER I1, I2, N

!$OMP PARALLEL SHARED(A,B,I1,I2)
!$OMP SECTIONS
!$OMP SECTION
     DO I1 = I1, N
       IF (A(I1).NE.0.0) EXIT
     ENDDO
!$OMP SECTION
     DO I2 = I2, N
       IF (B(I2).NE.0.0) EXIT
     ENDDO
!$OMP END SECTIONS
!$OMP SINGLE
    IF (I1.LE.N) PRINT *, &#39;ITEMS IN A UP TO &#39;, I1, &#39;ARE ALL ZERO.&#39;
    IF (I2.LE.N) PRINT *, &#39;ITEMS IN B UP TO &#39;, I2, &#39;ARE ALL ZERO.&#39;
!$OMP END SINGLE
!$OMP END PARALLEL

END SUBROUTINE PLOOP_2
</pre></div>
</div>
</div>
</div>
<p>Note however that the use of shared loop iteration variables can easily lead to  race conditions.</p>
</section>
<section id="fortran-restrictions-on-shared-and-private-clauses-with-common-blocks">
<h2><span class="section-number">9.5. </span>Fortran Restrictions on <strong>shared</strong> and <strong>private</strong> Clauses with Common Blocks<a class="headerlink" href="#fortran-restrictions-on-shared-and-private-clauses-with-common-blocks" title="Permalink to this headline">#</a></h2>
<p>When a named common block is specified in a <strong>private</strong>, <strong>firstprivate</strong>,  or <strong>lastprivate</strong> clause of a construct, none of its members may be declared  in another data-sharing attribute clause on that construct. The following examples  illustrate this point.</p>
<p>The following example is conforming:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sp_common</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">SHARED</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is also conforming:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sp_common</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD2</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">          </span><span class="n">ENDDO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">          </span><span class="n">ENDDO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD2</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is conforming:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sp_common</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD3</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">SHARED</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_GOOD3</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is non-conforming because <strong>x</strong> is a constituent element  of <strong>c</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sp_common</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_WRONG</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">Incorrect</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constituent</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">),</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_WRONG</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is non-conforming because a common block may not be declared  both shared and private:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sp_common</span><span class="mf">.5</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_WRONG2</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">Incorrect</span><span class="o">:</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">both</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">private</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">),</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="o">/</span><span class="n">C</span><span class="o">/</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COMMON_WRONG2</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fortran-restrictions-on-storage-association-with-the-private-clause">
<h2><span class="section-number">9.6. </span>Fortran Restrictions on Storage Association with the <strong>private</strong> Clause<a class="headerlink" href="#fortran-restrictions-on-storage-association-with-the-private-clause" title="Permalink to this headline">#</a></h2>
<p>The following non-conforming examples illustrate the implications of the <strong>private</strong>  clause rules with regard to storage association.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sa_private</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">       </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="p">()</span><span class="w"></span>
<span class="w">       </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">BLOCK</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">       </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">X</span><span class="w">             </span><span class="o">!</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="w"></span>

<span class="w">       </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT</span><span class="w"></span>
<span class="w">         </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">BLOCK</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">         </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">    </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"></span>
<span class="w">         </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB</span><span class="p">()</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sa_private</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT2</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">BLOCK2</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="w"></span>
<span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"></span>
<span class="w">          </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB</span><span class="p">()</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="w">       </span><span class="n">CONTAINS</span><span class="w"></span>

<span class="w">          </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="p">()</span><span class="w"></span>
<span class="w">          </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">BLOCK2</span><span class="o">/</span><span class="w"> </span><span class="n">Y</span><span class="w"></span>

<span class="w">          </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">X</span><span class="w">               </span><span class="o">!</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">          </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">Y</span><span class="w">               </span><span class="o">!</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">          </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="w"></span>

<span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT2</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sa_private</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT3</span><span class="w"></span>
<span class="w">        </span><span class="n">EQUIVALENCE</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">Y</span><span class="w">                  </span><span class="o">!</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">          </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">          </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="n">X</span><span class="w">                  </span><span class="o">!</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT3</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sa_private</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT4</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">EQUIVALENCE</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">51</span><span class="p">),</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">DEFAULT</span><span class="p">(</span><span class="n">PRIVATE</span><span class="p">)</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="n">LASTPRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="w"></span>
<span class="w">             </span><span class="n">DO</span><span class="w"> </span><span class="n">J</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="w"></span>
<span class="w">               </span><span class="n">B</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">J</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">             </span><span class="n">ENDDO</span><span class="w"></span>

<span class="w">             </span><span class="n">DO</span><span class="w"> </span><span class="n">J</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="w"></span>
<span class="w">               </span><span class="n">A</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">J</span><span class="w">   </span><span class="o">!</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">becomes</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">point</span><span class="w"></span>
<span class="w">             </span><span class="n">ENDDO</span><span class="w"></span>

<span class="w">             </span><span class="n">DO</span><span class="w"> </span><span class="n">J</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">50</span><span class="w"></span>
<span class="w">               </span><span class="n">B</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="o">!</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">                         </span><span class="o">!</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">becomes</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">point</span><span class="w"></span>
<span class="w">             </span><span class="n">ENDDO</span><span class="w"></span>
<span class="w">          </span><span class="n">ENDDO</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w">       </span><span class="o">!</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">LASTPRIVATE</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">has</span><span class="w"></span>
<span class="w">                            </span><span class="o">!</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">results</span><span class="w"></span>

<span class="w">         </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="w">    </span><span class="o">!</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LASTPRIVATE</span><span class="w"></span>
<span class="w">                       </span><span class="o">!</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">defined</span><span class="w"></span>
<span class="w">       </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT4</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">fort_sa_private</span><span class="mf">.5</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w">    </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB1</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">DIMENSION</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">conform</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">specification</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">legal</span><span class="w"> </span><span class="n">Fortran</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">OpenMP</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">allows</span><span class="w"> </span><span class="n">the</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">association</span><span class="w"> </span><span class="n">that</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="w"></span>

<span class="w">        </span><span class="n">FORALL</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB1</span><span class="w"></span>

<span class="w">      </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">PRIV_RESTRICT5</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">BLOCK5</span><span class="o">/</span><span class="w"> </span><span class="n">A</span><span class="w"></span>

<span class="w">        </span><span class="n">DIMENSION</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">EQUIVALENCE</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">words</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="o">/</span><span class="n">BLOCK5</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">Without</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">clause</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">passing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">member</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sequence</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">ten</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="kt">long</span><span class="p">.</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">With</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">clause</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="n">be</span><span class="w"></span>
<span class="w">          </span><span class="o">!</span><span class="w"> </span><span class="n">sequence</span><span class="o">-</span><span class="n">associated</span><span class="p">.</span><span class="w"></span>

<span class="w">          </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB1</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">MASKED</span><span class="w"></span>
<span class="w">            </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">     </span><span class="n">END</span><span class="w"> </span><span class="n">MASKED</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="c-c-arrays-in-a-firstprivate-clause">
<h2><span class="section-number">9.7. </span>C/C++ Arrays in a <strong>firstprivate</strong> Clause<a class="headerlink" href="#c-c-arrays-in-a-firstprivate-clause" title="Permalink to this headline">#</a></h2>
<p>The following example illustrates the size and value of list items of array or  pointer type in a <strong>firstprivate</strong> clause . The size of new list items is  based on the type of the corresponding original list item, as determined by the  base language.</p>
<p>In this example:</p>
<ul class="simple">
<li><p>The type of <strong>A</strong> is array of two arrays of two ints.</p></li>
<li><p>The type of <strong>B</strong> is adjusted to pointer to array of <strong>n</strong>  ints, because it is a function parameter.</p></li>
<li><p>The type of <strong>C</strong> is adjusted to pointer to int, because  it is a function parameter.</p></li>
<li><p>The type of <strong>D</strong> is array of two arrays of two ints.</p></li>
<li><p>The type of <strong>E</strong> is array of <strong>n</strong> arrays of <strong>n</strong>  ints.</p></li>
</ul>
<p>Note that  <strong>B</strong> and <strong>E</strong> involve variable length array types.</p>
<p>The new items of array type are initialized as if each integer element of the original  array is assigned to the corresponding element of the new array. Those of pointer  type are initialized as if by assignment from the original item to the new item.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: carrays_fpriv.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">n</span><span class="p">],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">C</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">n</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel firstprivate(B, C, D, E)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="n">n</span><span class="p">]));</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Private B and C have values of original B and C. */</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="lastprivate-clause">
<h2><span class="section-number">9.8. </span><strong>lastprivate</strong> Clause<a class="headerlink" href="#lastprivate-clause" title="Permalink to this headline">#</a></h2>
<p>Correct execution sometimes depends on the value that the last iteration of a loop  assigns to a variable. Such programs must list all such variables in a <strong>lastprivate</strong>  clause  so that the values of the variables are the same as when the loop is executed  sequentially.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: lastprivate.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">lastpriv</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp for lastprivate(i)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w">      </span><span class="cm">/* i == n-1 here */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">lastprivate</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">LASTPRIV</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">LASTPRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="mi">-1</span><span class="w"></span>
<span class="w">          </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">I</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">ENDDO</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">here</span><span class="w"></span>

<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">LASTPRIV</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The next example illustrates the use of the <strong>conditional</strong> modifier in a <strong>lastprivate</strong> clause to return the last value when it may not come from the last iteration of a loop. That is, users can preserve the serial equivalence semantics of the loop. The conditional lastprivate ensures the final value of the variable after the loop  is as if the loop iterations were executed in a sequential order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: lastprivate.2</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="kt">float</span><span class="w"> </span><span class="nf">condlastprivate</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp parallel for simd lastprivate(conditional: x)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">108.5</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">208.5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinf</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">lastprivate</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.0</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">condlastprivate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">   </span><span class="n">real</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"></span>

<span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>

<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="n">lastprivate</span><span class="p">(</span><span class="n">conditional</span><span class="o">:</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">108.5</span><span class="w"> </span><span class="p">.</span><span class="n">or</span><span class="p">.</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">208.5</span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w"></span>
<span class="w">         </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">endif</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">condlastprivate</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reduction">
<h2><span class="section-number">9.9. </span>Reduction<a class="headerlink" href="#reduction" title="Permalink to this headline">#</a></h2>
<p>This section covers ways to perform reductions in parallel, task, taskloop, and SIMD regions.</p>
<section id="reduction-clause">
<h3><span class="section-number">9.9.1. </span><strong>reduction</strong> Clause<a class="headerlink" href="#reduction-clause" title="Permalink to this headline">#</a></h3>
<p>The following example demonstrates the <strong>reduction</strong> clause; note that some  reductions can be expressed in the loop in several ways, as shown for the <strong>max</strong>  and <strong>min</strong> reductions below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: reduction.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_3.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">reduction1</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel for private(i) shared(x, y, n) \</span>
<span class="cp">                          reduction(+:a) reduction(^:b) \</span>
<span class="cp">                          reduction(min:c) reduction(max:d)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">REDUCTION1</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"></span>
<span class="w">    </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="o">+:</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="o">&amp;</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">IEOR</span><span class="o">:</span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">MIN</span><span class="o">:</span><span class="n">C</span><span class="p">)</span><span class="w">  </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">MAX</span><span class="o">:</span><span class="n">D</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEOR</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">IF</span><span class="w"> </span><span class="p">(</span><span class="n">D</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>

<span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">REDUCTION1</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>A common implementation of the preceding example is to treat it as if it had been  written as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: reduction.2</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">reduction2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">b_p</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">c_p</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">a_p</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d_p</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel shared(a, b, c, d, x, y, n) \</span>
<span class="cp">                          private(a_p, b_p, c_p, d_p)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">b_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">d_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">HUGE_VALF</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp for private(i)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">a_p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">b_p</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c_p</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="n">c_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">d_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">d_p</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp critical</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a_p</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">b_p</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">c_p</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_p</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmaxf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">d_p</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="w">  </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">REDUCTION2</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"></span>
<span class="w">    </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="w"></span>
<span class="w">    </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">A_P</span><span class="p">,</span><span class="w"> </span><span class="n">D_P</span><span class="w"></span>
<span class="w">    </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">B_P</span><span class="p">,</span><span class="w"> </span><span class="n">C_P</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="o">&amp;</span><span class="w">         </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">A_P</span><span class="p">,</span><span class="w"> </span><span class="n">B_P</span><span class="p">,</span><span class="w"> </span><span class="n">C_P</span><span class="p">,</span><span class="w"> </span><span class="n">D_P</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">A_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">      </span><span class="n">B_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">      </span><span class="n">C_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="n">C_P</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">D_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">HUGE</span><span class="p">(</span><span class="n">D_P</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">        </span><span class="n">A_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A_P</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">B_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEOR</span><span class="p">(</span><span class="n">B_P</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">C_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">C_P</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">IF</span><span class="w"> </span><span class="p">(</span><span class="n">D_P</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="n">D_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">CRITICAL</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A_P</span><span class="w"></span>
<span class="w">        </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IEOR</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">B_P</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">C_P</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">D_P</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">CRITICAL</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">  </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">REDUCTION2</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following program is non-conforming because the reduction is on the  <strong>intrinsic procedure name</strong> <strong>MAX</strong> but that name has been redefined to be the variable  named <strong>MAX</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION_WRONG</span><span class="w"></span>
<span class="w"> </span><span class="n">MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w"> </span><span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">MAX</span><span class="o">:</span><span class="w"> </span><span class="n">M</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">MAX</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">intrinsic</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">conforming</span><span class="w"></span>
<span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">    </span><span class="n">CALL</span><span class="w"> </span><span class="n">SUB</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>

<span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION_WRONG</span><span class="w"></span>

<span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">SUB</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following conforming program performs the reduction using the  <strong>intrinsic procedure name</strong> <strong>MAX</strong> even though the intrinsic <strong>MAX</strong> has been renamed  to <strong>REN</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="n">MODULE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">   </span><span class="n">INTRINSIC</span><span class="w"> </span><span class="n">MAX</span><span class="w"></span>
<span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>

<span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION3</span><span class="w"></span>
<span class="w">   </span><span class="n">USE</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">REN</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MAX</span><span class="w"></span>
<span class="w">   </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">REN</span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w">     </span><span class="o">!</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">MAX</span><span class="w"></span>
<span class="w">   </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">      </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">I</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION3</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following conforming program performs the reduction using   <em>intrinsic procedure name</em>  <strong>MAX</strong> even though the intrinsic <strong>MAX</strong> has been renamed  to <strong>MIN</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.5</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="n">MODULE</span><span class="w"> </span><span class="n">MOD</span><span class="w"></span>
<span class="w">   </span><span class="n">INTRINSIC</span><span class="w"> </span><span class="n">MAX</span><span class="p">,</span><span class="w"> </span><span class="n">MIN</span><span class="w"></span>
<span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">MOD</span><span class="w"></span>

<span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION4</span><span class="w"></span>
<span class="w">   </span><span class="n">USE</span><span class="w"> </span><span class="n">MOD</span><span class="p">,</span><span class="w"> </span><span class="n">MIN</span><span class="o">=&gt;</span><span class="n">MAX</span><span class="p">,</span><span class="w"> </span><span class="n">MAX</span><span class="o">=&gt;</span><span class="n">MIN</span><span class="w"></span>
<span class="w">   </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">R</span><span class="w"></span>
<span class="w">   </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">HUGE</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="n">MIN</span><span class="o">:</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w">     </span><span class="o">!</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">MAX</span><span class="w"></span>
<span class="w">   </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">      </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">SIN</span><span class="p">(</span><span class="n">REAL</span><span class="p">(</span><span class="n">I</span><span class="p">)))</span><span class="w"></span>
<span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>
<span class="w">   </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"></span>
<span class="n">END</span><span class="w"> </span><span class="n">PROGRAM</span><span class="w"> </span><span class="n">REDUCTION4</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example is non-conforming because the initialization (<strong>a =  0</strong>) of the original list item <strong>a</strong> is not synchronized with the update of  <strong>a</strong> as a result of the reduction computation in the <strong>for</strong> loop. Therefore,  the example may print an incorrect value for <strong>a</strong>.</p>
<p>To avoid this problem, the initialization of the original list item <strong>a</strong>  should complete before any update of <strong>a</strong> as a result of the <strong>reduction</strong>  clause. This can be achieved by adding an explicit barrier after the assignment  <strong>a = 0</strong>, or by enclosing the assignment <strong>a = 0</strong> in a <strong>single</strong>  directive (which has an implied barrier), or by initializing <strong>a</strong> before  the start of the <strong>parallel</strong> region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: reduction.6</span>
<span class="cm">* type: C</span>
<span class="cm">* version:    omp_5.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel shared(a) private(i)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp masked</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// To avoid race conditions, add a barrier here.</span>

<span class="w">    </span><span class="cp">#pragma omp for reduction(+:a)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp single</span>
<span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Sum is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.6</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w">    </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="w">      </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">SHARED</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">PRIVATE</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">MASKED</span><span class="w"></span>
<span class="w">      </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">MASKED</span><span class="w"></span>

<span class="w">      </span><span class="o">!</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="n">avoid</span><span class="w"> </span><span class="n">race</span><span class="w"> </span><span class="n">conditions</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">barrier</span><span class="w"> </span><span class="n">here</span><span class="p">.</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">DO</span><span class="w"> </span><span class="n">REDUCTION</span><span class="p">(</span><span class="o">+:</span><span class="n">A</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">DO</span><span class="w"> </span><span class="n">I</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="w">         </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">DO</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">      </span><span class="n">PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sum is &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>

<span class="w">      </span><span class="n">END</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example demonstrates the reduction of array  <em>a</em> .  In C/C++ this is illustrated by the explicit use of an array section  <em>a[0:N]</em>  in the <strong>reduction</strong> clause.  The corresponding Fortran example uses array syntax supported in the base language.  As of the OpenMP 4.5 specification the explicit use of array section in the <strong>reduction</strong> clause in Fortran is not permitted.  But this oversight has been fixed in the OpenMP 5.0 specification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: reduction.7</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_4.5</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="cp">#define N 100</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)[</span><span class="n">N</span><span class="p">]);</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">N</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="n">init</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">b</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0e0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp parallel for reduction(+:a[0:N]) private(j)</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="w">       </span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w">  </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; a[0] a[N-1]: %f %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="mi">-1</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">reduction</span><span class="mf">.7</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="n">program</span><span class="w"> </span><span class="n">array_red</span><span class="w"></span>

<span class="w">  </span><span class="n">integer</span><span class="p">,</span><span class="n">parameter</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w">           </span><span class="o">::</span><span class="w"> </span><span class="n">j</span><span class="w"></span>
<span class="w">  </span><span class="n">real</span><span class="w">              </span><span class="o">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0e0</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">     </span><span class="n">a</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="o">:</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="w">  </span><span class="n">print</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; a(1) a(n): &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-reduction">
<h3><span class="section-number">9.9.2. </span>Task Reduction<a class="headerlink" href="#task-reduction" title="Permalink to this headline">#</a></h3>
<p>In OpenMP 5.0 the <strong>task_reduction</strong> clause was created for the <strong>taskgroup</strong> construct,  to allow reductions among explicit tasks that have an <strong>in_reduction</strong> clause.</p>
<p>In the  <em>task_reduction.1</em>  example below a reduction is performed as the algorithm traverses a linked list. The reduction statement is assigned to be an explicit task using a <strong>task</strong> construct and is specified to be a reduction participant with  the <strong>in_reduction</strong> clause. A <strong>taskgroup</strong> construct encloses the tasks participating in the reduction, and specifies, with the <strong>task_reduction</strong> clause, that the taskgroup has tasks participating in a reduction.  After the <strong>taskgroup</strong> region the original variable will contain  the final value of the reduction.</p>
<p>Note: The  <em>res</em>  variable is private in the  <em>linked_list_sum</em>  routine and is not required to be shared (as in the case of a <strong>parallel</strong> construct reduction).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       task_reduction.1</span>
<span class="cm">* type:       C</span>
<span class="cm">*/</span><span class="w"></span>

<span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#define N 10</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">node_tag</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">node_tag</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">node_t</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">linked_list_sum</span><span class="p">(</span><span class="n">node_t</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp taskgroup task_reduction(+: res)</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">node_t</span><span class="o">*</span><span class="w"> </span><span class="n">aux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">aux</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">#pragma omp task in_reduction(+: res)</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">aux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="c1">//                           Create the root node.</span>
<span class="w">    </span><span class="n">node_t</span><span class="o">*</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">node_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">node_t</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">node_t</span><span class="o">*</span><span class="w"> </span><span class="n">aux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">;</span><span class="w"></span>

<span class="c1">//                           Create N-1 more nodes.</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">node_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">node_t</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp parallel</span>
<span class="w">    </span><span class="cp">#pragma omp single</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linked_list_sum</span><span class="p">(</span><span class="n">root</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Calculated: %d  Analytic:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w">       </span><span class="n">task_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w">       </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>

<span class="n">module</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="n">node_t</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">        </span><span class="n">type</span><span class="p">(</span><span class="n">node_t</span><span class="p">),</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">next</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="n">type</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">m</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">linked_list_sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">node_t</span><span class="p">),</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">node_t</span><span class="p">),</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">aux</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"> </span><span class="n">task_reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">associated</span><span class="p">(</span><span class="n">aux</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aux</span><span class="o">%</span><span class="n">val</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">task</span><span class="w"></span>
<span class="w">            </span><span class="n">aux</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">aux</span><span class="o">%</span><span class="n">next</span><span class="w"></span>
<span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">linked_list_sum</span><span class="w"></span>


<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">node_t</span><span class="p">),</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">aux</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="w"></span>

<span class="w">    </span><span class="n">interface</span><span class="w"></span>
<span class="w">        </span><span class="n">function</span><span class="w"> </span><span class="n">linked_list_sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">use</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="w">            </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">            </span><span class="n">type</span><span class="p">(</span><span class="n">node_t</span><span class="p">),</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<span class="w">            </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="o">!</span><span class="w">                       </span><span class="n">Create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="n">allocate</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">root</span><span class="o">%</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">aux</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">root</span><span class="w"></span>

<span class="o">!</span><span class="w">                       </span><span class="n">Create</span><span class="w"> </span><span class="n">N</span><span class="mi">-1</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">        </span><span class="n">allocate</span><span class="p">(</span><span class="n">aux</span><span class="o">%</span><span class="n">next</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">aux</span><span class="o">%</span><span class="n">next</span><span class="w"></span>
<span class="w">        </span><span class="n">aux</span><span class="o">%</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="w">    </span><span class="n">aux</span><span class="o">%</span><span class="n">next</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">null</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linked_list_sum</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Calculated:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; Analytic:&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In OpenMP 5.0 the <strong>task</strong>  <em>reduction-modifier</em>  for the <strong>reduction</strong> clause was introduced to provide a means of performing reductions among implicit and explicit tasks.</p>
<p>The <strong>reduction</strong> clause of a <strong>parallel</strong> or worksharing construct may specify the <strong>task</strong>  <em>reduction-modifier</em>  to include explicit task reductions within their region, provided the reduction operators ( <em>reduction-identifiers</em> ) and variables ( <em>list items</em> ) of the participating tasks match those of the implicit tasks.</p>
<p>There are 2 reduction use cases (identified by USE CASE #) in the  <em>task_reduction.2</em>  example below.</p>
<p>In USE CASE 1 a <strong>task</strong> modifier in the <strong>reduction</strong> clause  of the <strong>parallel</strong> construct is used to include the reductions of any  participating tasks, those with an <strong>in_reduction</strong> clause and matching   <em>reduction-identifiers</em>  (<strong>+</strong>) and list items (<strong>x</strong>).</p>
<p>Note, a <strong>taskgroup</strong> construct (with a <strong>task_reduction</strong> clause) in not necessary to scope the explicit task reduction (as seen in the example above).  Hence, even without the implicit task reduction statement (without the C <strong>x++</strong>   and Fortran <strong>x=x+1</strong> statements), the <strong>task</strong>  <em>reduction-modifier</em>   in a <strong>reduction</strong> clause of the <strong>parallel</strong> construct can be used to avoid having to create a <strong>taskgroup</strong> construct  (and its <strong>task_reduction</strong> clause) around the task generating structure.</p>
<p>In USE CASE 2 tasks participating in the reduction are within a worksharing region (a parallel worksharing-loop construct). Here, too, no <strong>taskgroup</strong> is required, and the  <em>reduction-identifier</em>  (<strong>+</strong>) and list item (variable <strong>x</strong>) match as required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       task_reduction.2</span>
<span class="cm">* type:       C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>

<span class="c1">// USE CASE 1  explicit-task reduction + parallel reduction clause</span>
<span class="w">   </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp parallel num_threads(M) reduction(task,+:x)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w">                </span><span class="c1">// implicit task reduction statement</span>

<span class="w">     </span><span class="cp">#pragma omp single</span>
<span class="w">     </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="cp">#pragma omp task in_reduction(+:x)</span>
<span class="w">       </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;x=%d  =M+N</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="w">  </span><span class="c1">// x= 110  =M+N</span>


<span class="c1">// USE CASE 2  task reduction +  worksharing reduction clause</span>
<span class="w">   </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp parallel for num_threads(M) reduction(task,+:x)</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>

<span class="w">      </span><span class="n">x</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">       </span><span class="cp">#pragma omp task in_reduction(+:x)</span>
<span class="w">       </span><span class="n">x</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;x=%d  =N-N/2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">x</span><span class="p">);</span><span class="w">  </span><span class="c1">// x= 50  =N-N/2</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name:       task_reduction.2
! type:       F-free
! version:    omp_5.0

program task_modifier

   integer :: N=100, M=10
   integer :: i, x

! USE CASE 1  explicit-task reduction + parallel reduction clause
   x=0
   !$omp parallel num_threads(M) reduction(task,+:x)

     x=x+1                   !! implicit task reduction statement

     !$omp single
       do i = 1,N
         !$omp task in_reduction(+:x)
           x=x+1
         !$omp end task
       end do
     !$omp end single

   !$omp end parallel
   write(*,&#39;(&quot;x=&quot;,I0,&quot; =M+N&quot;)&#39;) x   ! x= 110 =M+N


! USE CASE 2  task reduction +  worksharing reduction clause
   x=0
   !$omp parallel do num_threads(M) reduction(task,+:x)
     do i = 1,N

        x=x+1

        if( mod(i,2) == 0) then
           !$omp task in_reduction(+:x)
             x=x-1
           !$omp end task
        endif

     end do
   write(*,&#39;(&quot;x=&quot;,I0,&quot;  =N-N/2&quot;)&#39;) x   ! x= 50 =N-N/2

end program
</pre></div>
</div>
</div>
</div>
</section>
<section id="reduction-on-combined-target-constructs">
<h3><span class="section-number">9.9.3. </span>Reduction on Combined Target Constructs<a class="headerlink" href="#reduction-on-combined-target-constructs" title="Permalink to this headline">#</a></h3>
<p>When a <strong>reduction</strong> clause appears on a combined construct that combines  a <strong>target</strong> construct with another construct, there is an implicit map  of the list items with a <strong>tofrom</strong> map type for the <strong>target</strong> construct.  Otherwise, the list items (if they are scalar variables) would be  treated as firstprivate by default in the <strong>target</strong> construct, which  is unlikely to provide the intended behavior since the result of the reduction that is in the firstprivate variable would be discarded  at the end of the <strong>target</strong> region.</p>
<p>In the following example, the use of the <strong>reduction</strong> clause on <strong>sum1</strong> or <strong>sum2</strong> should, by default, result in an implicit <strong>tofrom</strong> map for that variable. So long as neither <strong>sum1</strong> nor <strong>sum2</strong> were already present on the device, the mapping behavior ensures the value for <strong>sum1</strong> computed in the first <strong>target</strong> construct is used in the second <strong>target</strong> construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: target_reduction.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">sum1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp target teams distribute reduction(+:sum1)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sum1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp target teams distribute reduction(+:sum2)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">sum2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum1</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="w">  </span><span class="s">&quot;sum1 = %d, sum2 = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//OUTPUT: sum1 = 9900, sum2 = 147015000</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">target_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.0</span><span class="w"></span>
<span class="n">program</span><span class="w"> </span><span class="n">target_reduction_ex1</span><span class="w"></span>
<span class="w">   </span><span class="n">interface</span><span class="w"></span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">          </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">          </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">   </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="n">distribute</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum1</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="w"></span>
<span class="w">          </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="n">distribute</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum2</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="w"></span>
<span class="w">          </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">sum1</span><span class="w"></span>
<span class="w">       </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">   </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sum1 = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, sum2 = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="w"></span>
<span class="w">   </span><span class="o">!!</span><span class="n">OUTPUT</span><span class="o">:</span><span class="w"> </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="mi">10100</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">153015000</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>


<span class="n">integer</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">2</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="n">integer</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">   </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">3</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In next example,  the variables <strong>sum1</strong> and <strong>sum2</strong> remain on the device for the duration of the <strong>target</strong> <strong>data</strong> region so that it is their device copies that are updated by the reductions. Note the significance of mapping <strong>sum1</strong> on the second <strong>target</strong> construct; otherwise, it would be treated by default as firstprivate and the result computed for <strong>sum1</strong> in the prior <strong>target</strong> region may not be used. Alternatively, a <strong>target</strong> <strong>update</strong> construct could be used between the two <strong>target</strong> constructs to update the host version of <strong>sum1</strong> with the value that is in the corresponding device version after the completion of the first construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: target_reduction.2</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">sum1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp target data map(sum1,sum2)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp target teams distribute reduction(+:sum1)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">sum1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="cp">#pragma omp target teams distribute map(sum1) reduction(+:sum2)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">sum2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sum1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="w">  </span><span class="s">&quot;sum1 = %d, sum2 = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//OUTPUT: sum1 = 9900, sum2 = 147015000</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">target_reduction</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.0</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">target_reduction_ex2</span><span class="w"></span>
<span class="w">   </span><span class="n">interface</span><span class="w"></span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">          </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">      </span><span class="n">function</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">          </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="w">   </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="n">distribute</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum1</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="w"></span>
<span class="w">              </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">       </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="n">distribute</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">sum1</span><span class="p">)</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum2</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="w"></span>
<span class="w">              </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">sum1</span><span class="w"></span>
<span class="w">           </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">data</span><span class="w"></span>
<span class="w">   </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sum1 = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, sum2 = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="w"></span>
<span class="w">   </span><span class="o">!!</span><span class="n">OUTPUT</span><span class="o">:</span><span class="w"> </span><span class="n">sum1</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="mi">10100</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">153015000</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>


<span class="n">integer</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">   </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">2</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
<span class="n">integer</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">   </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">*</span><span class="mi">3</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-reduction-with-target-constructs">
<h3><span class="section-number">9.9.4. </span>Task Reduction with Target Constructs<a class="headerlink" href="#task-reduction-with-target-constructs" title="Permalink to this headline">#</a></h3>
<p>The following examples illustrate how task reductions can apply to target tasks that result from a <strong>target</strong> construct with the <strong>in_reduction</strong> clause. Here, the <strong>in_reduction</strong> clause specifies that the target task participates in the task reduction defined in the scope of the enclosing <strong>taskgroup</strong> construct. Partial results from all tasks participating in the task reduction will be combined (in some order) into the original variable listed in the <strong>task_reduction</strong> clause before exiting the <strong>taskgroup</strong> region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: target_task_reduction.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.2</span>
<span class="cm">*/</span><span class="w"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#pragma omp declare target enter(device_compute)</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp parallel masked</span>
<span class="w">   </span><span class="cp">#pragma omp taskgroup task_reduction(+:sum)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp target in_reduction(+:sum) nowait</span>
<span class="w">          </span><span class="n">device_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="cp">#pragma omp task in_reduction(+:sum)</span>
<span class="w">          </span><span class="n">host_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="w">  </span><span class="s">&quot;sum = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//OUTPUT: sum = 2</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w">   </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">target_task_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.2</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">target_task_reduction_ex1</span><span class="w"></span>
<span class="w">   </span><span class="n">interface</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">enter</span><span class="p">(</span><span class="n">device_compute</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"> </span><span class="n">task_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="n">nowait</span><span class="w"></span>
<span class="w">            </span><span class="n">call</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">call</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">task</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">   </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sum = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="o">!!</span><span class="n">OUTPUT</span><span class="o">:</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>

<span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In the next pair of examples, the task reduction is defined by a <strong>reduction</strong> clause with the <strong>task</strong> modifier, rather than a <strong>task_reduction</strong> clause on a <strong>taskgroup</strong> construct. Again, the partial results from the participating tasks will be combined in some order into the original reduction variable, <strong>sum</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: target_task_reduction.2a</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.2</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#pragma omp declare target enter(device_compute)</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp parallel sections reduction(task, +:sum)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp section</span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="cp">#pragma omp target in_reduction(+:sum)</span>
<span class="w">             </span><span class="n">device_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp section</span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="n">host_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="w">  </span><span class="s">&quot;sum = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//OUTPUT: sum = 2</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w">   </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">target_task_reduction</span><span class="mf">.2</span><span class="n">a</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.2</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">target_task_reduction_ex2</span><span class="w"></span>
<span class="w">   </span><span class="n">interface</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">enter</span><span class="p">(</span><span class="n">device_compute</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">sections</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">section</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="n">nowait</span><span class="w"></span>
<span class="w">           </span><span class="n">call</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">section</span><span class="w"></span>
<span class="w">         </span><span class="n">call</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">sections</span><span class="w"></span>
<span class="w">   </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sum = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="o">!!</span><span class="n">OUTPUT</span><span class="o">:</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>

<span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>Next, the <strong>task</strong> modifier is again used to define a task reduction over participating tasks. This time, the participating tasks are a target task resulting from a <strong>target</strong> construct with the <strong>in_reduction</strong> clause, and the implicit task (executing on the primary thread) that calls <strong>host_compute</strong>. As before, the partial results from these participating tasks are combined in some order into the original reduction variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: target_task_reduction.2b</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.2</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#pragma omp declare target enter(device_compute)</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp parallel masked reduction(task, +:sum)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="cp">#pragma omp target in_reduction(+:sum) nowait</span>
<span class="w">       </span><span class="n">device_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>

<span class="w">       </span><span class="n">host_compute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="w">  </span><span class="s">&quot;sum = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//OUTPUT: sum = 2</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">device_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w">   </span><span class="nf">host_compute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="p">){</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">target_task_reduction</span><span class="mf">.2</span><span class="n">b</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.2</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">target_task_reduction_ex2b</span><span class="w"></span>
<span class="w">   </span><span class="n">interface</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">enter</span><span class="p">(</span><span class="n">device_compute</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="w"></span>
<span class="w">      </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="w"></span>
<span class="w">   </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="n">nowait</span><span class="w"></span>
<span class="w">           </span><span class="n">call</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"></span>
<span class="w">         </span><span class="n">call</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">   </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sum = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="o">!!</span><span class="n">OUTPUT</span><span class="o">:</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>


<span class="n">subroutine</span><span class="w"> </span><span class="n">device_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">host_compute</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="taskloop-reduction">
<h3><span class="section-number">9.9.5. </span>Taskloop Reduction<a class="headerlink" href="#taskloop-reduction" title="Permalink to this headline">#</a></h3>
<p>In the OpenMP 5.0 Specification the <strong>taskloop</strong> construct was extended to include the reductions.</p>
<p>The following two examples show how to implement a reduction over an array using taskloop reduction in two different ways. In the first example we apply the <strong>reduction</strong> clause to the <strong>taskloop</strong> construct. As it was explained above in the task reduction examples, a reduction over tasks is divided in two components: the scope of the reduction, which is defined by a <strong>taskgroup</strong> region, and the tasks that participate in the reduction. In this example, the <strong>reduction</strong> clause defines both semantics. First, it specifies that the implicit <strong>taskgroup</strong> region associated with the <strong>taskloop</strong> construct is the scope of the reduction, and second, it defines all tasks created by the <strong>taskloop</strong> construct as participants of the reduction. About the first property, it is important to note that if we add the <strong>nogroup</strong> clause to the <strong>taskloop</strong> construct the code will be nonconforming, basically because we have a set of tasks that participate in a reduction that has not been defined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       taskloop_reduction.1</span>
<span class="cm">* type:       C</span>
<span class="cm">* version:    omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">array_sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp taskloop reduction(+: res)</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp parallel</span>
<span class="w">    </span><span class="cp">#pragma omp single</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">taskloop_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w">    </span><span class="n">omp_5</span><span class="mf">.0</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskloop</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">array_sum</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">    </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">array_sum</span><span class="w"></span>

<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">        </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The result is&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The second example computes exactly the same value as in the preceding  <em>taskloop_reduction.1</em>  code section, but in a very different way. First, in the  <em>array_sum</em>  function a <strong>taskgroup</strong> region is created  that defines the scope of a new reduction using the <strong>task_reduction</strong> clause. After that, a task and also the tasks generated by a taskloop participate in  that reduction by using the <strong>in_reduction</strong> clause on the <strong>task</strong> and <strong>taskloop</strong> constructs, respectively.  Note that the <strong>nogroup</strong> clause was added to the <strong>taskloop</strong> construct. This is allowed because what is expressed with the <strong>in_reduction</strong> clause is different from what is expressed with the <strong>reduction</strong> clause. In one case the generated tasks are specified to participate in a previously  declared reduction (<strong>in_reduction</strong> clause) whereas in the other case creation of a new reduction is specified and also all tasks generated  by the taskloop will participate on it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       taskloop_reduction.2</span>
<span class="cm">* type:       C</span>
<span class="cm">* version:    omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">array_sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp taskgroup task_reduction(+: res)</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">#pragma omp task in_reduction(+: res)</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>

<span class="w">            </span><span class="cp">#pragma omp taskloop in_reduction(+: res) nogroup</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cp">#pragma omp parallel</span>
<span class="w">    </span><span class="cp">#pragma omp single</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">taskloop_reduction</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w">    </span><span class="n">omp_5</span><span class="mf">.0</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"> </span><span class="n">task_reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">then</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">task</span><span class="w"></span>

<span class="w">        </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="n">nogroup</span><span class="w"></span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskloop</span><span class="w"></span>
<span class="w">    </span><span class="n">endif</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskgroup</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">array_sum</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">    </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">array_sum</span><span class="w"></span>

<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">        </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The result is&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In the OpenMP 5.0 Specification, <strong>reduction</strong> clauses for the <strong>taskloop simd</strong> construct were also added.</p>
<p>The examples below compare reductions for the <strong>taskloop</strong> and the <strong>taskloop</strong> <strong>simd</strong> constructs. These examples illustrate the use of <strong>reduction</strong> clauses within  “stand-alone” <strong>taskloop</strong> constructs, and the use of <strong>in_reduction</strong> clauses for tasks of taskloops to participate with other reductions within the scope of a parallel region.</p>
<p><strong>taskloop reductions:</strong></p>
<p>In the  <em>taskloop reductions</em>  section of the example below,   <em>taskloop 1</em>  uses the <strong>reduction</strong> clause  in a <strong>taskloop</strong> construct for a sum reduction, accumulated in  <em>asum</em> .  The behavior is as though a <strong>taskgroup</strong> construct encloses the  taskloop region with a <strong>task_reduction</strong> clause, and each taskloop task has an <strong>in_reduction</strong> clause with the specifications  of the <strong>reduction</strong> clause. At the end of the taskloop region  <em>asum</em>  contains the result of the reduction.</p>
<p>The next taskloop,  <em>taskloop 2</em> , illustrates the use of the  <strong>in_reduction</strong> clause to participate in a previously defined reduction scope of a <strong>parallel</strong> construct.</p>
<p>The task reductions of  <em>task 2</em>  and  <em>taskloop 2</em>  are combined across the <strong>taskloop</strong> construct and the single <strong>task</strong> construct, as specified in the <strong>reduction(task,</strong> <strong>+:asum)</strong> clause of the <strong>parallel</strong> construct. At the end of the parallel region  <em>asum</em>  contains the combined result of all reductions.</p>
<p><strong>taskloop simd reductions:</strong></p>
<p>Reductions for the <strong>taskloop</strong> <strong>simd</strong> construct are shown in the second half of the code. Since each component construct, <strong>taskloop</strong> and <strong>simd</strong>,  can accept a reduction-type clause, the <strong>taskloop</strong> <strong>simd</strong> construct is a composite construct, and the specific application of the reduction clause is defined within the <strong>taskloop</strong> <strong>simd</strong> construct section of the OpenMP 5.0 Specification. The code below illustrates use cases for these reductions.</p>
<p>In the  <em>taskloop simd reduction</em>  section of the example below,  <em>taskloop simd 3</em>  uses the <strong>reduction</strong> clause  in a <strong>taskloop</strong> <strong>simd</strong> construct for a sum reduction within a loop. For this case a <strong>reduction</strong> clause is used, as one would use  for a <strong>simd</strong> construct. The SIMD reductions of each task are combined, and the results of these tasks are further  combined just as in the <strong>taskloop</strong> construct with the <strong>reduction</strong> clause for  <em>taskloop 1</em> . At the end of the taskloop region  <em>asum</em>  contains the combined result of all reductions.</p>
<p>If a <strong>taskloop</strong> <strong>simd</strong> construct is to participate in a previously defined  reduction scope, the reduction participation should be specified with a <strong>in_reduction</strong> clause, as shown in the <strong>parallel</strong> region enclosing  <em>task 4</em>  and  <em>taskloop simd 4</em>  code sections.</p>
<p>Here the <strong>taskloop</strong> <strong>simd</strong> construct’s  <strong>in_reduction</strong> clause specifies participation of the construct’s tasks as  a task reduction within the scope of the parallel region.   That is, the results of each task of the <strong>taskloop</strong> construct component  contribute to the reduction in a broader level, just as in  <em>parallel reduction a</em>  code section above. Also, each <strong>simd</strong>-component construct occurs as if it has a <strong>reduction</strong> clause, and the SIMD results of each task are combined as though to form a single result for each task (that participates in the <strong>in_reduction</strong> clause). At the end of the parallel region  <em>asum</em>  contains the combined result of all reductions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: taskloop_simd_reduction.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_5.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#define N 100</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">asum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// taskloop reductions</span>

<span class="w">   </span><span class="cp">#pragma omp parallel masked</span>
<span class="w">   </span><span class="cp">#pragma omp taskloop reduction(+:asum) </span><span class="c1">// taskloop 1</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>


<span class="w">   </span><span class="cp">#pragma omp parallel reduction(task, +:asum) </span><span class="c1">// parallel reduction a</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp masked</span>
<span class="w">      </span><span class="cp">#pragma omp task            in_reduction(+:asum) </span><span class="c1">// task 2</span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="cp">#pragma omp masked taskloop in_reduction(+:asum) </span><span class="c1">// taskloop 2</span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// taskloop simd reductions</span>

<span class="w">   </span><span class="cp">#pragma omp parallel masked</span>
<span class="w">   </span><span class="cp">#pragma omp taskloop simd reduction(+:asum) </span><span class="c1">// taskloop simd 3</span>
<span class="w">     </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>


<span class="w">   </span><span class="cp">#pragma omp parallel reduction(task, +:asum) </span><span class="c1">// parallel reduction b</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp masked</span>
<span class="w">      </span><span class="cp">#pragma omp task                 in_reduction(+:asum) </span><span class="c1">// task 4</span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="cp">#pragma omp masked taskloop simd in_reduction(+:asum) </span><span class="c1">// taskloop</span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w">                  </span><span class="c1">// simd 4</span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;asum=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">asum</span><span class="p">);</span><span class="w"> </span><span class="c1">// output: asum=29700</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">taskloop_simd_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>

<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">omp_lib</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="o">::</span><span class="w">  </span><span class="n">N</span><span class="o">=</span><span class="mi">100</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w">            </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="w"> </span><span class="n">asum</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[(</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"> </span><span class="p">)]</span><span class="w">    </span><span class="o">!!</span><span class="w"> </span><span class="n">initialize</span><span class="w"></span>

<span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">reductions</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">                  </span><span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskloop</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>


<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">            </span><span class="o">!!</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="n">a</span><span class="w"></span>

<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">task</span><span class="w">            </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">     </span><span class="o">!!</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">task</span><span class="w"></span>
<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>

<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">     </span><span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">     </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="n">taskloop</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>

<span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="n">reductions</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">             </span><span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>


<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w">            </span><span class="o">!!</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="n">b</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">task</span><span class="w">                 </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">task</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>

<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="n">in_reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">asum</span><span class="p">)</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">       </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">;</span><span class="w">  </span><span class="n">asum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">  </span><span class="n">enddo</span><span class="w"></span>
<span class="w">    </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">masked</span><span class="w"> </span><span class="n">taskloop</span><span class="w"> </span><span class="n">simd</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>

<span class="w">  </span><span class="n">print</span><span class="o">*</span><span class="p">,</span><span class="s">&quot;asum=&quot;</span><span class="p">,</span><span class="n">asum</span><span class="w">   </span><span class="o">!!</span><span class="w"> </span><span class="n">output</span><span class="o">:</span><span class="w"> </span><span class="n">asum</span><span class="o">=</span><span class="mi">30300</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reduction-with-the-scope-construct">
<h3><span class="section-number">9.9.6. </span>Reduction with the <strong>scope</strong> Construct<a class="headerlink" href="#reduction-with-the-scope-construct" title="Permalink to this headline">#</a></h3>
<p>The following example illustrates the use of the <strong>scope</strong> construct  to perform a reduction in a <strong>parallel</strong> region. The case is useful for  producing a reduction and accessing reduction variables inside a <strong>parallel</strong> region  without using a worksharing-loop construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: scope_reduction.1</span>
<span class="cm">* type: C++</span>
<span class="cm">* version: omp_5.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">do_work</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">loc_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">        </span><span class="c1">// local sum</span>
<span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nthrs</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp for</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">loc_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp single</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">               </span><span class="c1">// total sum</span>
<span class="w">      </span><span class="n">nthrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp scope reduction(+:s,nthrs)</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">loc_s</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">nthrs</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp masked</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;total sum = %f, nthrs = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">nthrs</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">float</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp parallel</span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">do_work</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">scope_reduction</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="n">subroutine</span><span class="w"> </span><span class="n">do_work</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">   </span><span class="n">real</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">loc_s</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="p">,</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">nthrs</span><span class="w"></span>

<span class="w">   </span><span class="n">loc_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">                </span><span class="o">!</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">         </span><span class="n">loc_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loc_s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">                 </span><span class="o">!</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="w">      </span><span class="n">nthrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">single</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="o">+:</span><span class="n">s</span><span class="p">,</span><span class="n">nthrs</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_s</span><span class="w"></span>
<span class="w">      </span><span class="n">nthrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nthrs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">scope</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="w">      </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;total sum = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, nthrs = &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nthrs</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">masked</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>

<span class="n">function</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">   </span><span class="n">integer</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">   </span><span class="n">real</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">s</span><span class="w"></span>

<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">      </span><span class="n">call</span><span class="w"> </span><span class="n">do_work</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="user-defined-reduction">
<h3><span class="section-number">9.9.7. </span>User-Defined Reduction<a class="headerlink" href="#user-defined-reduction" title="Permalink to this headline">#</a></h3>
<p>The <strong>declare</strong> <strong>reduction</strong> directive can be used to specify  user-defined reductions (UDR) for user data types.</p>
<p>In the following example, <strong>declare</strong> <strong>reduction</strong> directives are used to define  <em>min</em>  and  <em>max</em>  operations for the  <em>point</em>  data structure for computing the rectangle that encloses a set of 2-D points.</p>
<p>Each <strong>declare</strong> <strong>reduction</strong> directive defines new reduction identifiers,  <em>min</em>  and  <em>max</em> , to be used in a <strong>reduction</strong> clause. The next item in the declaration list is the data type ( <em>struct</em>   <em>point</em> ) used in the reduction, followed by the combiner, here the functions  <em>minproc</em>  and  <em>maxproc</em>  perform the min and max operations, respectively, on the user data (of type  <em>struct</em>   <em>point</em> ). In the function argument list are two special OpenMP variable identifiers, <strong>omp_in</strong> and <strong>omp_out</strong>, that denote the two values to be combined in the “real” function; the <strong>omp_out</strong> identifier indicates which one is to hold the result.</p>
<p>The initializer of the <strong>declare</strong> <strong>reduction</strong> directive specifies the initial value for the private variable of each implicit task. The <strong>omp_priv</strong> identifier is used to denote the private variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: udr.1</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_4.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">minproc</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">maxproc</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#pragma omp declare reduction(min : struct point : \</span>
<span class="cp">        minproc(&amp;omp_out, &amp;omp_in)) \</span>
<span class="cp"> initializer( omp_priv = { INT_MAX, INT_MAX } )</span>

<span class="cp">#pragma omp declare reduction(max : struct point : \</span>
<span class="cp">        maxproc(&amp;omp_out, &amp;omp_in)) \</span>
<span class="cp"> initializer( omp_priv = { 0, 0 } )</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">find_enclosing_rectangle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="n">points</span><span class="p">[]</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">INT_MAX</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="cp">#pragma omp parallel for reduction(min:minp) reduction(max:maxp)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">minproc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">     </span><span class="n">maxproc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maxp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;min = (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;max = (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example shows the corresponding code in Fortran.  The <strong>declare</strong> <strong>reduction</strong> directives are specified as part of  the declaration in subroutine  <em>find_enclosing_rectangle</em>  and  the procedures that perform the min and max operations are specified as subprograms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">udr</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="n">module</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>

<span class="w">  </span><span class="n">type</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">point</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">type</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>

<span class="n">subroutine</span><span class="w"> </span><span class="n">find_enclosing_rectangle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>
<span class="w">  </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">  </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">minproc</span><span class="p">(</span><span class="n">omp_out</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">  </span><span class="n">initializer</span><span class="p">(</span><span class="w"> </span><span class="n">omp_priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">maxproc</span><span class="p">(</span><span class="n">omp_out</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">  </span><span class="n">initializer</span><span class="p">(</span><span class="w"> </span><span class="n">omp_priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">min</span><span class="o">:</span><span class="n">minp</span><span class="p">)</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">max</span><span class="o">:</span><span class="n">maxp</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">     </span><span class="n">call</span><span class="w"> </span><span class="n">minproc</span><span class="p">(</span><span class="n">minp</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="n">call</span><span class="w"> </span><span class="n">maxproc</span><span class="p">(</span><span class="n">maxp</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;min = (&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;max = (&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>

<span class="w"> </span><span class="n">contains</span><span class="w"></span>
<span class="w">  </span><span class="n">subroutine</span><span class="w"> </span><span class="n">minproc</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">),</span><span class="w"> </span><span class="n">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">out</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">),</span><span class="w"> </span><span class="n">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">in</span><span class="w"></span>

<span class="w">    </span><span class="n">out</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">minproc</span><span class="w"></span>

<span class="w">  </span><span class="n">subroutine</span><span class="w"> </span><span class="n">maxproc</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">),</span><span class="w"> </span><span class="n">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">out</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">),</span><span class="w"> </span><span class="n">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">in</span><span class="w"></span>

<span class="w">    </span><span class="n">out</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"> </span><span class="n">maxproc</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example shows the same computation as  <em>udr.1</em>  but it illustrates that you can craft complex expressions in the user-defined reduction declaration. In this case, instead of calling the  <em>minproc</em>  and  <em>maxproc</em>  functions we inline the code in a single expression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: udr.2</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_4.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cp">#pragma omp declare reduction(min : struct point : \</span>
<span class="cp">        omp_out.x = omp_in.x &gt; omp_out.x  ? omp_out.x : omp_in.x, \</span>
<span class="cp">        omp_out.y = omp_in.y &gt; omp_out.y  ? omp_out.y : omp_in.y ) \</span>
<span class="cp">        initializer( omp_priv = { INT_MAX, INT_MAX } )</span>

<span class="cp">#pragma omp declare reduction(max : struct point : \</span>
<span class="cp">        omp_out.x = omp_in.x &lt; omp_out.x  ? omp_out.x : omp_in.x,  \</span>
<span class="cp">        omp_out.y = omp_in.y &lt; omp_out.y  ? omp_out.y : omp_in.y ) \</span>
<span class="cp">        initializer( omp_priv = { 0, 0 } )</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">find_enclosing_rectangle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="n">points</span><span class="p">[]</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">INT_MAX</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="cp">#pragma omp parallel for reduction(min:minp) reduction(max:maxp)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;min = (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;max = (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The corresponding code of the same example in Fortran is very similar except that the assignment expression in the <strong>declare</strong> <strong>reduction</strong> directive can only be used for a single variable, in this case through a type structure constructor  <em>point( … )</em> .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">udr</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="n">module</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>

<span class="w">  </span><span class="n">type</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">point</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">type</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>

<span class="n">subroutine</span><span class="w"> </span><span class="n">find_enclosing_rectangle</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">data_type</span><span class="w"></span>
<span class="w">  </span><span class="n">implicit</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">  </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">:</span><span class="w">  </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">   </span><span class="n">omp_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="w"> </span><span class="n">omp_out</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">                   </span><span class="n">min</span><span class="p">(</span><span class="w"> </span><span class="n">omp_out</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">   </span><span class="n">initializer</span><span class="p">(</span><span class="w"> </span><span class="n">omp_priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">:</span><span class="w">  </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">   </span><span class="n">omp_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="w"> </span><span class="n">omp_out</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">                   </span><span class="n">max</span><span class="p">(</span><span class="w"> </span><span class="n">omp_out</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">omp_in</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w">   </span><span class="n">initializer</span><span class="p">(</span><span class="w"> </span><span class="n">omp_priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">type</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">minp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">HUGE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">maxp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">min</span><span class="o">:</span><span class="w"> </span><span class="n">minp</span><span class="p">)</span><span class="w"> </span><span class="n">reduction</span><span class="p">(</span><span class="n">max</span><span class="o">:</span><span class="w"> </span><span class="n">maxp</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">     </span><span class="n">minp</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">minp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="n">minp</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">minp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="n">maxp</span><span class="o">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">maxp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="n">maxp</span><span class="o">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">maxp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;min = (&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">minp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;max = (&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="o">%</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">maxp</span><span class="o">%</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example shows the use of special variables in arguments for combiner (<strong>omp_in</strong> and <strong>omp_out</strong>) and initializer (<strong>omp_priv</strong> and <strong>omp_orig</strong>) routines.  This example returns the maximum value of an array and the corresponding index value. The <strong>declare</strong> <strong>reduction</strong> directive specifies a user-defined reduction operation  <em>maxloc</em>  for data type  <em>struct</em>   <em>mx_s</em> . The function  <em>mx_combine</em>  is the combiner and the function  <em>mx_init</em>  is the initializer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: udr.3</span>
<span class="cm">* type: C</span>
<span class="cm">* version: omp_4.0</span>
<span class="cm">*/</span><span class="w"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#define N 100</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* prototype functions for combiner and initializer in</span>
<span class="cm">   the declare reduction */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">mx_combine</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">mx_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">);</span><span class="w"></span>

<span class="cp">#pragma omp declare reduction(maxloc: struct mx_s: \</span>
<span class="cp">        mx_combine(&amp;omp_out, &amp;omp_in)) \</span>
<span class="cp">        initializer(mx_init(&amp;omp_priv, &amp;omp_orig))</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mx_combine</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">out</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mx_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="o">*</span><span class="n">orig</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">mx_s</span><span class="w"> </span><span class="n">mx</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mf">0.8f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">mx</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="n">mx</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="cp">#pragma omp parallel for reduction(maxloc: mx)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mx</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">mx</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">         </span><span class="n">mx</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;max value = %g, index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">index</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="cm">/* prints 10000, 80 */</span><span class="w"></span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>Below is the corresponding Fortran version of the above example.  The <strong>declare</strong> <strong>reduction</strong> directive specifies the user-defined operation  <em>maxloc</em>  for user-derived type  <em>mx_s</em> .  The combiner  <em>mx_combine</em>  and the initializer  <em>mx_init</em>  are specified as subprograms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name: udr.3
! type: F-free
! version: omp_4.0
program max_loc
   implicit none

   type :: mx_s
      real value
      integer index
   end type

   !$omp declare reduction(maxloc: mx_s: &amp;
   !$omp&amp;        mx_combine(omp_out, omp_in)) &amp;
   !$omp&amp;        initializer(mx_init(omp_priv, omp_orig))

   integer, parameter :: N = 100
   type(mx_s) :: mx
   real :: val(N), d
   integer :: i, count

   count = N
   do i = 1, count
      d = N*0.8 - i + 1
      val(i) = N * N - d * d
   enddo

   mx%value = val(1)
   mx%index = 1
   !$omp parallel do reduction(maxloc: mx)
   do i = 2, count
      if (mx%value &lt; val(i)) then
         mx%value = val(i)
         mx%index = i
      endif
   enddo

   print *, &#39;max value = &#39;, mx%value, &#39; index = &#39;, mx%index
   ! prints 10000, 81

 contains

 subroutine mx_combine(out, in)
   implicit none
   type(mx_s), intent(inout) :: out
   type(mx_s), intent(in) :: in

   if ( out%value &lt; in%value ) then
      out%value = in%value
      out%index = in%index
   endif
 end subroutine mx_combine

 subroutine mx_init(priv, orig)
   implicit none
   type(mx_s), intent(out) :: priv
   type(mx_s), intent(in) :: orig

   priv%value = orig%value
   priv%index = orig%index
 end subroutine mx_init

end program
</pre></div>
</div>
</div>
</div>
<p>The following example explains a few details of the user-defined reduction  in Fortran through modules. The <strong>declare</strong> <strong>reduction</strong> directive is declared in a module ( <em>data_red</em> ).  The reduction-identifier  <em>.add.</em>  is a user-defined operator that is to allow accessibility in the scope that performs the reduction operation. The user-defined operator  <em>.add.</em>  and the subroutine  <em>dt_init</em>  specified in the <strong>initializer</strong> clause are defined in the same subprogram.</p>
<p>The reduction operation (that is, the <strong>reduction</strong> clause) is in the main program. The reduction identifier  <em>.add.</em>  is accessible by use association. Since  <em>.add.</em>  is a user-defined operator, the explicit interface should also be accessible by use association in the current program unit. Since the <strong>declare</strong> <strong>reduction</strong> associated to this <strong>reduction</strong> clause has the <strong>initializer</strong> clause, the subroutine specified on the clause must be accessible in the current scoping unit.  In this case, the subroutine  <em>dt_init</em>  is accessible by use association.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">udr</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="n">module</span><span class="w"> </span><span class="n">data_red</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">type</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="n">type</span><span class="w"> </span><span class="n">dt</span><span class="w"></span>
<span class="w">    </span><span class="n">real</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">r1</span><span class="w"></span>
<span class="w">    </span><span class="n">real</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">r2</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">type</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="o">-</span><span class="n">defined</span><span class="w"> </span><span class="n">operator</span><span class="w"> </span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="n">interface</span><span class="w"> </span><span class="n">operator</span><span class="p">(.</span><span class="n">add</span><span class="p">.)</span><span class="w"></span>
<span class="w">    </span><span class="n">module</span><span class="w"> </span><span class="n">procedure</span><span class="w"> </span><span class="n">addc</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">interface</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="o">-</span><span class="n">defined</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="n">operator</span><span class="w"> </span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">reduction</span><span class="p">(.</span><span class="n">add</span><span class="p">.</span><span class="o">:</span><span class="n">dt</span><span class="o">:</span><span class="n">omp_out</span><span class="o">=</span><span class="n">omp_out</span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="n">omp_in</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="o">&amp;</span><span class="w"> </span><span class="n">initializer</span><span class="p">(</span><span class="n">dt_init</span><span class="p">(</span><span class="n">omp_priv</span><span class="p">))</span><span class="w"></span>

<span class="w"> </span><span class="n">contains</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">routine</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="n">subroutine</span><span class="w"> </span><span class="n">dt_init</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">u</span><span class="w"></span>
<span class="w">    </span><span class="n">u</span><span class="o">%</span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">    </span><span class="n">u</span><span class="o">%</span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">subroutine</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">procedure</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="w"> </span><span class="n">operator</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="n">function</span><span class="w"> </span><span class="n">addc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">xresult</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span><span class="w"> </span><span class="n">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="w"></span>
<span class="w">    </span><span class="n">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">xresult</span><span class="w"></span>
<span class="w">    </span><span class="n">xresult</span><span class="o">%</span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="o">%</span><span class="n">r1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x2</span><span class="o">%</span><span class="n">r2</span><span class="w"></span>
<span class="w">    </span><span class="n">xresult</span><span class="o">%</span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="o">%</span><span class="n">r2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x2</span><span class="o">%</span><span class="n">r1</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="n">function</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">data_red</span><span class="w"></span>

<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
<span class="w">  </span><span class="n">use</span><span class="w"> </span><span class="n">data_red</span><span class="p">,</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">dt_init</span><span class="p">,</span><span class="w"> </span><span class="n">operator</span><span class="p">(.</span><span class="n">add</span><span class="p">.)</span><span class="w"></span>

<span class="w">  </span><span class="n">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">xdt1</span><span class="p">,</span><span class="w"> </span><span class="n">xdt2</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">  </span><span class="n">xdt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">xdt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">)</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">reduction</span><span class="w"> </span><span class="n">operation</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">reduction</span><span class="p">(.</span><span class="n">add</span><span class="p">.</span><span class="o">:</span><span class="w"> </span><span class="n">xdt1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">    </span><span class="n">xdt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdt1</span><span class="w"> </span><span class="p">.</span><span class="n">add</span><span class="p">.</span><span class="w"> </span><span class="n">xdt2</span><span class="w"></span>
<span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">do</span><span class="w"></span>

<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">xdt1</span><span class="w"></span>

<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example uses user-defined reductions to declare a plus (+) reduction for a C++ class. As the <strong>declare</strong> <strong>reduction</strong> directive is inside the context of the  <em>V</em>  class the expressions in the <strong>declare</strong> <strong>reduction</strong> directive are resolved in the context of the class. Also, note that the <strong>initializer</strong> clause uses a copy constructor to initialize the private variables of the reduction and it uses as parameter to its original variable by using the special variable <strong>omp_orig</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: udr.5</span>
<span class="cm">* type: C++</span>
<span class="cm">* version: omp_4.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="n">class</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>

<span class="n">public</span><span class="o">:</span><span class="w"></span>
<span class="w">   </span><span class="n">V</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_n</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="p">(</span><span class="n">_n</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">n</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">V</span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">V</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">n</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">~</span><span class="n">V</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">V</span><span class="o">&amp;</span><span class="w"> </span><span class="n">operator</span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">V</span><span class="o">&amp;</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="cp">#pragma omp declare reduction( + : V : omp_out += omp_in ) \</span>
<span class="cp">           initializer(omp_priv(omp_orig))</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following examples shows how user-defined reductions can be defined for some STL containers. The first <strong>declare</strong> <strong>reduction</strong> defines the plus (+) operation for  <em>std::vector<int></em>  by making use of the  <em>std::transform</em>  algorithm. The second and third define the merge (or concatenation) operation for  <em>std::vector<int></em>  and  <em>std::list<int></em> .  It shows how the user-defined reduction operation can be applied to specific data types of an STL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: udr.6</span>
<span class="cm">* type: C++</span>
<span class="cm">* version: omp_4.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>

<span class="cp">#pragma omp declare reduction( + : std::vector&lt;int&gt; : \</span>
<span class="cp">     std::transform (omp_out.begin(), omp_out.end(),  \</span>
<span class="cp">        omp_in.begin(), omp_in.end(),std::plus&lt;int&gt;()))</span>

<span class="cp">#pragma omp declare reduction( merge : std::vector&lt;int&gt; : \</span>
<span class="cp">     omp_out.insert(omp_out.end(), omp_in.begin(), omp_in.end()))</span>

<span class="cp">#pragma omp declare reduction( merge : std::list&lt;int&gt; : \</span>
<span class="cp">     omp_out.merge(omp_in))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="scan-directive">
<h2><span class="section-number">9.10. </span><strong>scan</strong> Directive<a class="headerlink" href="#scan-directive" title="Permalink to this headline">#</a></h2>
<p>The following examples illustrate how to parallelize a loop that saves  the <strong>prefix sum</strong> of a reduction. This is accomplished by using  the <strong>inscan</strong> modifier in the <strong>reduction</strong> clause for the input  variable of the scan, and specifying with a <strong>scan</strong> directive whether  the storage statement includes or excludes the scan input of the present  iteration ( <strong>k</strong> ).</p>
<p>Basically, the <strong>inscan</strong> modifier connects a loop and/or SIMD reduction to  the scan operation, and a <strong>scan</strong> construct with an <strong>inclusive</strong> or  <strong>exclusive</strong> clause specifies whether the “scan phase’’ (lexical block  before and after the directive, respectively) is to use an  <em>inclusive</em>  or   <em>exclusive</em>  scan value for the list item ( <strong>x</strong> ).</p>
<p>The first example uses the  <em>inclusive</em>  scan operation on a composite loop-SIMD construct. The <strong>scan</strong> directive separates the reduction  statement on variable  <strong>x</strong>  from the use of  <strong>x</strong>  (saving to array  <strong>b</strong> ). The order of the statements in this example indicates that value  <strong>a[k]</strong>  ( <strong>a(k)</strong>  in Fortran) is included in the computation of  the prefix sum  <strong>b[k]</strong>  ( <strong>b(k)</strong>  in Fortran) for iteration  <strong>k</strong> .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       scan.1</span>
<span class="cm">* type:       C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#define N 100</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">N</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// initialization</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// a[k] is included in the computation of producing results in b[k]</span>
<span class="w">   </span><span class="cp">#pragma omp parallel for simd reduction(inscan,+: x)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp scan inclusive(x)</span>
<span class="w">      </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;x = %d, b[0:3] = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//           5050,        1  3  6</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name:       scan.1
! type:       F-free
! version: omp_5.0
program inclusive_scan
   implicit none
   integer, parameter :: n = 100
   integer a(n), b(n)
   integer x, k

   ! initialization
   x = 0
   do k = 1, n
      a(k) = k
   end do

   ! a(k) is included in the computation of producing results in b(k)
   !$omp parallel do simd reduction(inscan,+: x)
   do k = 1, n
      x = x + a(k)
      !$omp scan inclusive(x)
      b(k) = x
   end do

   print *,&#39;x =&#39;, x, &#39;, b(1:3) =&#39;, b(1:3)
   !           5050,            1  3  6

end program
</pre></div>
</div>
</div>
</div>
<p>The second example uses the  <em>exclusive</em>  scan operation on a composite loop-SIMD construct. The <strong>scan</strong> directive separates the use of  <strong>x</strong>   (saving to array  <strong>b</strong> ) from the reduction statement on variable  <strong>x</strong> . The order of the statements in this example indicates that value  <strong>a[k]</strong>  ( <strong>a(k)</strong>  in Fortran) is excluded from the computation  of the prefix sum  <strong>b[k]</strong>  ( <strong>b(k)</strong>  in Fortran) for iteration  <strong>k</strong> .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name:       scan.2</span>
<span class="cm">* type:       C</span>
<span class="cm">* version: omp_5.0</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#define N 100</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">N</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// initialization</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// a[k] is not included in the computation of producing</span>
<span class="w">   </span><span class="c1">// results in b[k]</span>
<span class="w">   </span><span class="cp">#pragma omp parallel for simd reduction(inscan,+: x)</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="cp">#pragma omp scan exclusive(x)</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;x = %d, b[0:3] = %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//           5050,        0  1  3</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>!!%compiler: gfortran
!!%cflags: -fopenmp

! name:       scan.2
! type:       F-free
! version: omp_5.0
program exclusive_scan
   implicit none
   integer, parameter :: n = 100
   integer a(n), b(n)
   integer x, k

   ! initialization
   x = 0
   do k = 1, n
      a(k) = k
   end do

   ! a(k) is not included in the computation of producing results in b(k)
   !$omp parallel do simd reduction(inscan,+: x)
   do k = 1, n
      b(k) = x
      !$omp scan exclusive(x)
      x = x + a(k)
   end do

   print *,&#39;x =&#39;, x, &#39;, b(1:3) =&#39;, b(1:3)
   !           5050,            0  1  3

end program
</pre></div>
</div>
</div>
</div>
</section>
<section id="copyin-clause">
<h2><span class="section-number">9.11. </span><strong>copyin</strong> Clause<a class="headerlink" href="#copyin-clause" title="Permalink to this headline">#</a></h2>
<p>The <strong>copyin</strong> clause is used to initialize threadprivate data upon entry  to a <strong>parallel</strong> region. The value of the threadprivate variable in the primary thread is copied to the threadprivate variable of each other team member.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: copyin.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">work</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="kt">float</span><span class="w"> </span><span class="n">tol</span><span class="p">;</span><span class="w"></span>

<span class="cp">#pragma omp threadprivate(work,size,tol)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">build</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">work</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tol</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">copyin_example</span><span class="p">(</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">tol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel copyin(tol,size)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">build</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">copyin</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">MODULE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="p">,</span><span class="w"> </span><span class="n">POINTER</span><span class="p">,</span><span class="w"> </span><span class="n">SAVE</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">WORK</span><span class="p">(</span><span class="o">:</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">SIZE</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">TOL</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="p">(</span><span class="n">WORK</span><span class="p">,</span><span class="n">SIZE</span><span class="p">,</span><span class="n">TOL</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">MODULE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>

<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COPYIN_EXAMPLE</span><span class="p">(</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">USE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="w">        </span><span class="n">TOL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="w">        </span><span class="n">SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">PARALLEL</span><span class="w"> </span><span class="n">COPYIN</span><span class="p">(</span><span class="n">TOL</span><span class="p">,</span><span class="n">SIZE</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">CALL</span><span class="w"> </span><span class="n">BUILD</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">PARALLEL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">COPYIN_EXAMPLE</span><span class="w"></span>

<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">BUILD</span><span class="w"></span>
<span class="w">        </span><span class="n">USE</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">        </span><span class="n">ALLOCATE</span><span class="p">(</span><span class="n">WORK</span><span class="p">(</span><span class="n">SIZE</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">WORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TOL</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">BUILD</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="copyprivate-clause">
<h2><span class="section-number">9.12. </span><strong>copyprivate</strong> Clause<a class="headerlink" href="#copyprivate-clause" title="Permalink to this headline">#</a></h2>
<p>The <strong>copyprivate</strong> clause can be used to broadcast values acquired by a single  thread directly to all instances of the private variables in the other threads.  In this example, if the routine is called from the sequential part, its behavior  is not affected by the presence of the directives. If it is called from a <strong>parallel</strong>  region, then the actual arguments with which <strong>a</strong> and <strong>b</strong> are associated  must be private.</p>
<p>The thread that executes the structured block associated with the <strong>single</strong>   construct broadcasts the values of the private variables <strong>a</strong>, <strong>b</strong>,  <strong>x</strong>, and  <strong>y</strong> from its implicit task’s data environment to the data environments  of the other implicit tasks in the thread team. The broadcast completes before  any of the threads have left the barrier at the end of the construct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: copyprivate.1</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="cp">#pragma omp threadprivate(x, y)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#pragma omp single copyprivate(a,b,x,y)</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%f %f %f %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">copyprivate</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INIT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">REAL</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="w"></span>
<span class="w">        </span><span class="n">COMMON</span><span class="w"> </span><span class="o">/</span><span class="n">XY</span><span class="o">/</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">THREADPRIVATE</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">XY</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">READ</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">COPYPRIVATE</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="o">/</span><span class="n">XY</span><span class="o">/</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">INIT</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In this example, assume that the input must be performed by the primary thread.  Since the <strong>masked</strong> construct does not support the <strong>copyprivate</strong> clause,  it cannot broadcast the input value that is read. However, <strong>copyprivate</strong>  is used to broadcast an address where the input value is stored.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: copyprivate.2</span>
<span class="cm">* type: C</span>
<span class="cm">* version:    omp_5.1</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">float</span><span class="w"> </span><span class="nf">read_next</span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">return_val</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp single copyprivate(tmp)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span><span class="cm">/* copies the pointer only */</span><span class="w"></span>


<span class="w">  </span><span class="cp">#pragma omp masked</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp barrier</span>
<span class="w">  </span><span class="n">return_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp barrier</span>

<span class="w">  </span><span class="cp">#pragma omp single nowait</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">return_val</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">copyprivate</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w">    </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">READ_NEXT</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="p">,</span><span class="w"> </span><span class="n">POINTER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">TMP</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">COPYPRIVATE</span><span class="w"> </span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="w">  </span><span class="o">!</span><span class="w"> </span><span class="n">copies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">only</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">MASKED</span><span class="w"></span>
<span class="w">          </span><span class="n">READ</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">TMP</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">MASKED</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">BARRIER</span><span class="w"></span>
<span class="w">          </span><span class="n">READ_NEXT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TMP</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">BARRIER</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">DEALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">NOWAIT</span><span class="w"></span>
<span class="w">        </span><span class="n">END</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">READ_NEXT</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>Suppose that the number of lock variables required within a <strong>parallel</strong> region  cannot easily be determined prior to entering it. The <strong>copyprivate</strong> clause  can be used to provide access to shared lock variables that are allocated within  that <strong>parallel</strong> region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: copyprivate.3</span>
<span class="cm">* type: C</span>
<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="n">omp_lock_t</span><span class="w"> </span><span class="o">*</span><span class="nf">new_lock</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">omp_lock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock_ptr</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#pragma omp single copyprivate(lock_ptr)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lock_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">omp_lock_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">omp_lock_t</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">omp_init_lock</span><span class="p">(</span><span class="w"> </span><span class="n">lock_ptr</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">lock_ptr</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">copyprivate</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">NEW_LOCK</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="n">USE</span><span class="w"> </span><span class="n">OMP_LIB</span><span class="w">       </span><span class="o">!</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">INCLUDE</span><span class="w"> </span><span class="s">&quot;omp_lib.h&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">INTEGER</span><span class="p">(</span><span class="n">OMP_LOCK_KIND</span><span class="p">),</span><span class="w"> </span><span class="n">POINTER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">NEW_LOCK</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">ALLOCATE</span><span class="p">(</span><span class="n">NEW_LOCK</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">CALL</span><span class="w"> </span><span class="n">OMP_INIT_LOCK</span><span class="p">(</span><span class="n">NEW_LOCK</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">COPYPRIVATE</span><span class="p">(</span><span class="n">NEW_LOCK</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">NEW_LOCK</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>Note that the effect of the <strong>copyprivate</strong> clause on a variable with the  <strong>allocatable</strong> attribute is different than on a variable with the <strong>pointer</strong>  attribute. The value of <strong>A</strong> is copied (as if by intrinsic assignment) and  the pointer <strong>B</strong> is copied (as if by pointer assignment) to the corresponding  list items in the other implicit tasks belonging to the <strong>parallel</strong> region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">copyprivate</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="w">      </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">INTEGER</span><span class="w"> </span><span class="n">N</span><span class="w"></span>

<span class="w">        </span><span class="n">REAL</span><span class="p">,</span><span class="w"> </span><span class="n">DIMENSION</span><span class="p">(</span><span class="o">:</span><span class="p">),</span><span class="w"> </span><span class="n">ALLOCATABLE</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="w">        </span><span class="n">REAL</span><span class="p">,</span><span class="w"> </span><span class="n">DIMENSION</span><span class="p">(</span><span class="o">:</span><span class="p">),</span><span class="w"> </span><span class="n">POINTER</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">B</span><span class="w"></span>

<span class="w">        </span><span class="n">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="n">B</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="n">READ</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">COPYPRIVATE</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">is</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="kr">thread</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shared</span><span class="w"></span>

<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">BARRIER</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">SINGLE</span><span class="w"></span>
<span class="w">          </span><span class="n">DEALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$OMP</span><span class="w">   </span><span class="n">END</span><span class="w"> </span><span class="n">SINGLE</span><span class="w"> </span><span class="n">NOWAIT</span><span class="w"></span>
<span class="w">      </span><span class="n">END</span><span class="w"> </span><span class="n">SUBROUTINE</span><span class="w"> </span><span class="n">S</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="c-reference-in-data-sharing-clauses">
<h2><span class="section-number">9.13. </span>C++ Reference in Data-Sharing Clauses<a class="headerlink" href="#c-reference-in-data-sharing-clauses" title="Permalink to this headline">#</a></h2>
<p>C++ reference types are allowed in data-sharing attribute clauses as of OpenMP 4.5, except for the <strong>threadprivate</strong>, <strong>copyin</strong> and <strong>copyprivate</strong> clauses.   (See the Data-Sharing Attribute Clauses Section of the 4.5 OpenMP specification.) When a variable with C++ reference type is privatized, the object the reference refers to is privatized in addition to the reference itself. The following example shows the use of reference types in data-sharing clauses in the usual way. Additionally it shows how the data-sharing of formal arguments with a C++ reference type on an orphaned task generating construct is determined implicitly. (See the Data-sharing Attribute Rules for Variables Referenced in a Construct Section of the 4.5 OpenMP specification.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//%compiler: clang</span>
<span class="c1">//%cflags: -fopenmp</span>

<span class="cm">/*</span>
<span class="cm">* name: cpp_reference.1</span>
<span class="cm">* type: C++</span>
<span class="cm">* version: omp_4.5</span>
<span class="cm">*/</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">task_body</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">gen_task</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// on orphaned task construct reference argument</span>
<span class="w">  </span><span class="cp">#pragma omp task </span><span class="c1">// x is implicitly determined firstprivate(x)</span>
<span class="w">  </span><span class="n">task_body</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">test</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cp">#pragma omp parallel private(y)</span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gen_task</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="c1">// no matter if the argument is determined private</span>
<span class="w">    </span><span class="n">gen_task</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// or shared in the enclosing context.</span>

<span class="w">    </span><span class="n">y</span><span class="o">++</span><span class="p">;</span><span class="w">          </span><span class="c1">// each thread has its own int object y refers to</span>
<span class="w">    </span><span class="n">gen_task</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fortran-associate-construct">
<h2><span class="section-number">9.14. </span>Fortran <strong>ASSOCIATE</strong> Construct<a class="headerlink" href="#fortran-associate-construct" title="Permalink to this headline">#</a></h2>
<p>The following is an invalid example of specifying an associate name on a data-sharing attribute  clause. The constraint in the Data Sharing Attribute Rules section in the OpenMP  4.0 API Specifications states that an associate name preserves the association  with the selector established at the <strong>ASSOCIATE</strong> statement. The associate  name  <em>b</em>  is associated with the shared variable  <em>a</em> . With the predetermined data-sharing  attribute rule, the associate name  <em>b</em>  is not allowed to be specified on the <strong>private</strong>  clause.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">associate</span><span class="mf">.1</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="w">      </span><span class="n">program</span><span class="w"> </span><span class="n">example_broken</span><span class="w"></span>
<span class="w">      </span><span class="n">real</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="w">      </span><span class="n">associate</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">private</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">        </span><span class="o">!</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">privatize</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">      </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">b</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">associate</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>In next example, within the <strong>parallel</strong> construct, the association name  <em>thread_id</em>   is associated with the private copy of  <em>i</em> . The print statement should output the  unique thread number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">associate</span><span class="mf">.2</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">fixed</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="w">      </span><span class="n">program</span><span class="w"> </span><span class="n">example</span><span class="w"></span>
<span class="w">      </span><span class="n">use</span><span class="w"> </span><span class="n">omp_lib</span><span class="w"></span>
<span class="w">      </span><span class="n">integer</span><span class="w">  </span><span class="n">i</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">private</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="n">associate</span><span class="p">(</span><span class="n">thread_id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="w">       </span><span class="o">!</span><span class="w"> </span><span class="n">print</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">value</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">associate</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="w">      </span><span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example illustrates the effect of specifying a selector name on a data-sharing  attribute clause. The associate name  <em>u</em>  is associated with  <em>v</em>  and the variable  <em>v</em>   is specified on the <strong>private</strong> clause of the <strong>parallel</strong> construct.  The construct association is established prior to the <strong>parallel</strong> region.  The association between  <em>u</em>  and the original  <em>v</em>  is retained (see the Data Sharing  Attribute Rules section in the OpenMP 4.0 API Specifications). Inside the <strong>parallel</strong>  region,  <em>v</em>  has the value of -1 and  <em>u</em>  has the value of the original  <em>v</em> .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">associate</span><span class="mf">.3</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_4</span><span class="mf">.0</span><span class="w"></span>
<span class="n">program</span><span class="w"> </span><span class="n">example</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">v</span><span class="w"></span>
<span class="w">  </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w"></span>
<span class="n">associate</span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">private</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w">               </span><span class="o">!</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">v</span><span class="o">=</span><span class="mi">-1</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="w">               </span><span class="o">!</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">v</span><span class="o">=</span><span class="mi">15</span><span class="w"></span>
<span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">parallel</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">associate</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>The following example illustrates mapping behavior for a Fortran associate name and its selector for a <strong>target</strong> construct.</p>
<p>For the first 3 <strong>target</strong> constructs the associate name  <em>a_aray</em>  is associated with the selector  <em>aray</em> , an array.   For the <strong>target</strong> construct of code block TARGET 1 just the selector  <em>aray</em>  is used and is implicitly mapped, likewise for the associate name  <em>a_aray</em>  in the TARGET 2 block.   However, mapping an associate name and its selector is not valid for the same <strong>target</strong> construct.  Hence the TARGET 3 block is non-conforming.</p>
<p>In TARGET 4, the  <em>scalr</em>  selector used in the <strong>target</strong> region  has an implicit data-sharing attribute of firstprivate since it is a scalar. Hence, the assigned value is not returned. In TARGET 5, the associate name  <em>a_scalr</em>  is implicitly mapped and the assigned value is returned to the host (default <strong>tofrom</strong> mapping behavior). In TARGET 6, the use of the associate name and its selector in the <strong>target</strong> region is conforming because the scalar firstprivate behavior of the selector  and the implicit mapping of the associate name are allowed.   At the end of the <strong>target</strong> region only the  associate name’s value is returned to the host.  In TARGET 7, the selector and associate name appear in an explicit mapping for the same <strong>target</strong> construct,  hence the code block is non-conforming.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">!!%</span><span class="n">compiler</span><span class="o">:</span><span class="w"> </span><span class="n">gfortran</span><span class="w"></span>
<span class="o">!!%</span><span class="n">cflags</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">fopenmp</span><span class="w"></span>

<span class="o">!</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">associate</span><span class="mf">.4</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="o">-</span><span class="n">free</span><span class="w"></span>
<span class="o">!</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">omp_5</span><span class="mf">.1</span><span class="w"></span>
<span class="n">program</span><span class="w"> </span><span class="n">main</span><span class="w"></span>
<span class="w">  </span><span class="n">integer</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">scalr</span><span class="p">,</span><span class="w"> </span><span class="n">aray</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">aray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w"></span>

<span class="w">  </span><span class="n">associate</span><span class="p">(</span><span class="n">a_scalr</span><span class="o">=&gt;</span><span class="n">scalr</span><span class="p">,</span><span class="w"> </span><span class="n">a_aray</span><span class="o">=&gt;</span><span class="n">aray</span><span class="p">)</span><span class="w"></span>

<span class="w"> </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w">            </span><span class="o">!!</span><span class="w"> </span><span class="n">TARGET</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">aray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">a_aray</span><span class="p">,</span><span class="w"> </span><span class="n">aray</span><span class="w">  </span><span class="o">!!</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w">           </span><span class="o">!!</span><span class="w"> </span><span class="n">TARGET</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">a_aray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="n">$omp</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">target</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">a_aray</span><span class="p">,</span><span class="w"> </span><span class="n">aray</span><span class="w">  </span><span class="o">!!</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w">   </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>

<span class="o">!!!</span><span class="n">$omp</span><span class="w"> </span><span class="n">target</span><span class="w">           </span><span class="o">!!</span><span class="w"> </span><span class="n">TARGET</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="o">!!</span><span class="w">                       </span><span class="o">!!</span><span class="w"> </span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">implicit</span><span class="p">,</span><span class="w"></span>
<span class="o">!!</span><span class="w">                       </span><span class="o">!!</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">aray</span><span class="w"> </span><span class="no">AND</span><span class="w"> </span><span class="no">a_aray</span><span class="w"> </span><span class="no">NOT</span><span class="w"> </span><span class="no">ALLOWED</span><span class="w"></span>
<span class="o">!!</span><span class="w">    </span><span class="no">aray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="w"></span>
<span class="o">!!</span><span class="w">  </span><span class="no">a_aray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"></span>
<span class="o">!!!</span><span class="no">$omp</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">target</span><span class="w"></span>


<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">target</span><span class="w">              </span><span class="o">!!</span><span class="w"> </span><span class="no">TARGET</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="no">scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">               </span><span class="o">!!</span><span class="w"> </span><span class="no">scalr</span><span class="w"> </span><span class="no">is</span><span class="w"> </span><span class="no">firstprivate</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">target</span><span class="w"></span>
<span class="w">  </span><span class="no">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="no">a_scalr</span><span class="p">,</span><span class="w"> </span><span class="no">scalr</span><span class="w">   </span><span class="o">!!</span><span class="w"> </span><span class="mi">-1</span><span class="w">  </span><span class="mi">-1</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">target</span><span class="w">              </span><span class="o">!!</span><span class="w"> </span><span class="no">TARGET</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">    </span><span class="no">a_scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">             </span><span class="o">!!</span><span class="w"> </span><span class="no">a_scalr</span><span class="w"> </span><span class="no">implicitly</span><span class="w"> </span><span class="no">mapped</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">target</span><span class="w"></span>
<span class="w">  </span><span class="no">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="no">a_scalr</span><span class="p">,</span><span class="w"> </span><span class="no">scalr</span><span class="w">   </span><span class="o">!!</span><span class="w">  </span><span class="mi">2</span><span class="w">   </span><span class="mi">2</span><span class="w"></span>

<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">target</span><span class="w">              </span><span class="o">!!</span><span class="w"> </span><span class="no">TARGET</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">    </span><span class="no">scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">               </span><span class="o">!!</span><span class="w">          </span><span class="no">scalr</span><span class="w"> </span><span class="no">is</span><span class="w"> </span><span class="no">firstprivate</span><span class="w"></span>
<span class="w">    </span><span class="no">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="no">a_scalr</span><span class="p">,</span><span class="w"> </span><span class="no">scalr</span><span class="w"> </span><span class="o">!!</span><span class="w">  </span><span class="mi">2</span><span class="w">   </span><span class="mi">3</span><span class="w"></span>
<span class="w">    </span><span class="no">a_scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">             </span><span class="o">!!</span><span class="w">          </span><span class="no">a_scalr</span><span class="w"> </span><span class="no">implicitly</span><span class="w"> </span><span class="no">mapped</span><span class="w"></span>
<span class="w">    </span><span class="no">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="no">a_scalr</span><span class="p">,</span><span class="w"> </span><span class="no">scalr</span><span class="w"> </span><span class="o">!!</span><span class="w">  </span><span class="mi">4</span><span class="w">   </span><span class="mi">3</span><span class="w"></span>
<span class="w">  </span><span class="o">!</span><span class="no">$omp</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">target</span><span class="w"></span>
<span class="w">  </span><span class="no">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="no">a_scalr</span><span class="p">,</span><span class="w"> </span><span class="no">scalr</span><span class="w">   </span><span class="o">!!</span><span class="w">  </span><span class="mi">4</span><span class="w">   </span><span class="mi">4</span><span class="w"></span>

<span class="o">!!!</span><span class="no">$omp</span><span class="w"> </span><span class="no">target</span><span class="w"> </span><span class="no">map</span><span class="p">(</span><span class="no">a_scalr</span><span class="p">,</span><span class="no">scalr</span><span class="p">)</span><span class="w">  </span><span class="o">!!</span><span class="w"> </span><span class="no">TARGET</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="w">                                   </span><span class="o">!!</span><span class="w"> </span><span class="no">mapping</span><span class="p">,</span><span class="w"> </span><span class="no">in</span><span class="w"> </span><span class="no">this</span><span class="w"> </span><span class="no">case</span><span class="w"> </span><span class="no">explicit</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="o">!!</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">scalr</span><span class="w"> </span><span class="no">AND</span><span class="w"> </span><span class="no">a_sclar</span><span class="w"> </span><span class="no">NOT</span><span class="w"> </span><span class="no">ALLOWED</span><span class="w"></span>
<span class="o">!!</span><span class="w">    </span><span class="no">scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="o">!!</span><span class="w">  </span><span class="no">a_scalr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="o">!!!</span><span class="no">$omp</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">target</span><span class="w"></span>

<span class="w">  </span><span class="no">end</span><span class="w"> </span><span class="no">associate</span><span class="w"></span>

<span class="no">end</span><span class="w"> </span><span class="no">program</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "native"
        },
        kernelOptions: {
            kernelName: "native",
            path: "./contents/Chap_data_environment"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'native'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../Chap_synchronization/Chap_synchronization.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">8. </span>Synchronization</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../Chap_memory_model/Chap_memory_model.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">10. </span>Memory Model</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The OpenMP Community<br/>
  
      &copy; <a href="../../copyright.html">Copyright</a> 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>